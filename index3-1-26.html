<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#E63946">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SUNNY Stock">
    <meta name="application-name" content="SUNNY Stock">

    <!-- Link to Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å & ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ - SUNNY</title>

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iI0U2Mzk0NiIgcng9IjgwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIgZm9udC1zdHlsZT0iaXRhbGljIiBmb250LXNpemU9IjM1MCI+UzwvdGV4dD48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iI0U2Mzk0NiIgcng9IjgwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIgZm9udC1zdHlsZT0iaXRhbGljIiBmb250LXNpemU9IjM1MCI+UzwvdGV4dD48L3N2Zz4=">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Security
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && (e.keyCode == 85 || (e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)))) return false;
        };

        // Service Worker Setup
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ ServiceWorker Registered'))
                    .catch(err => console.warn('‚ö†Ô∏è ServiceWorker Failed:', err.message));
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCAWVxXlTIzt9zvuCZADEVYi1xCtJ8hdcA",
            authDomain: "sunny1988-a4483.firebaseapp.com",
            projectId: "sunny1988-a4483",
            storageBucket: "sunny1988-a4483.firebasestorage.app",
            messagingSenderId: "436626327232",
            appId: "1:436626327232:web:b3b67dd892aff358624f25"
        };

        let db = null, auth = null;
        let currentUser = null; // Holds the logged in user object
        let configListenerSet = false;
        let tempQuotes = []; // Store loaded quotes for easy access
        let currentEditingId = null; // ID for local storage edit
        let currentEditingDocId = null; // Doc ID for firestore edit
        
        const DEFAULT_CONFIG = {
            appTitle: "SUNNY",
            theme: 'default',
            menus: [
                { id: 'WOOD', name: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡πÑ‡∏°‡πâ', sub: '', icon: 'wood', active: true, bgImage: '' },
                { id: 'ALU', name: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°', sub: '25mm.', icon: 'alu', active: true, bgImage: '' },
                { id: 'PVC', name: '‡∏â‡∏≤‡∏Å PVC', sub: '(‡πÉ‡∏ö 8.5/10 cm)', icon: 'pvc', active: true, bgImage: '' },
                { id: 'ROLLER', name: '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô', sub: '', icon: 'roller', active: true, bgImage: '' }
            ],
            newsSettings: { speed: 3, showDate: true },
            newsItems: [],
            calcSettings: { enabled: true, factors: { fabricMult: 1.2, minArea: 1.2, eqExt: 1956, railTop: 200, railBot: 150, sling: 69 } },
            features: { experimental_mode: false }
        };
        
        let appConfig = DEFAULT_CONFIG;
        try {
            const saved = localStorage.getItem('sunny_app_config');
            if(saved) appConfig = JSON.parse(saved);
        } catch(e) {
            console.error("Config corrupted, resetting:", e);
            localStorage.removeItem('sunny_app_config');
        }
        
        if(!appConfig.calcSettings) appConfig.calcSettings = DEFAULT_CONFIG.calcSettings;
        if(!appConfig.theme) appConfig.theme = 'default';
        if(!appConfig.features) appConfig.features = DEFAULT_CONFIG.features;

        function initFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Listen to Auth State Changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in (either Anonymously or via Google)
                        currentUser = user;
                        console.log("Auth Status:", user.isAnonymous ? "Guest Mode" : "Member Mode (" + user.email + ")");
                        
                        // Update UI to show User Profile or Login Button
                        renderUserSidebar(user);
                        
                        // Load App Config (Realtime) - Only set listener once
                        if (!configListenerSet) {
                            db.collection("app_settings").doc("config").onSnapshot((doc) => {
                                if (doc.exists) {
                                    const newData = doc.data();
                                    checkAndNotifyNews(newData.newsItems || []);
                                    appConfig = newData;
                                    // Fallbacks
                                    if(!appConfig.calcSettings) appConfig.calcSettings = DEFAULT_CONFIG.calcSettings;
                                    if(!appConfig.newsItems) appConfig.newsItems = [];
                                    if(!appConfig.theme) appConfig.theme = 'default';
                                    
                                    localStorage.setItem('sunny_app_config', JSON.stringify(appConfig));
                                    renderSidebar(); 
                                    renderNews(); 
                                    applyTheme(appConfig.theme);
                                    if(currentSystem) switchSystem(currentSystem);
                                } else { 
                                    // Create default config if missing
                                    db.collection("app_settings").doc("config").set(appConfig); 
                                }
                            }, error => console.error("Config Listener Error:", error));
                            configListenerSet = true;
                        }

                    } else {
                        // No user signed in, sign in anonymously to ensure DB access for config
                        console.log("No user, signing in anonymously...");
                        auth.signInAnonymously().catch(e => console.error("Anon Auth Error:", e));
                    }
                });
            } catch (e) { console.error("Firebase Init Error:", e); }
        }

        // --- GOOGLE LOGIN FUNCTIONS ---
        function loginWithGoogle() {
            if (!auth) return;
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${result.user.displayName}`);
            }).catch((error) => {
                console.error(error);
                alert("Login Error: " + error.message);
            });
        }

        function logoutUser() {
            if (!auth) return;
            if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                auth.signOut().then(() => {
                    showToast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
                    // System will auto trigger signInAnonymously via onAuthStateChanged
                });
            }
        }

        function renderUserSidebar(user) {
            const container = document.getElementById('user-profile-section');
            if (!container) return; // Should be added in HTML

            if (user && !user.isAnonymous) {
                // Member Mode
                container.innerHTML = `
                    <div class="flex items-center gap-3 p-3 bg-red-50 rounded-xl border border-red-100 mb-2">
                        <img src="${user.photoURL || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-bold text-slate-400">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ,</div>
                            <div class="text-sm font-bold text-slate-700 truncate">${user.displayName}</div>
                        </div>
                        <button onclick="logoutUser()" class="text-slate-400 hover:text-red-500 p-1" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                        </button>
                    </div>
                    <button onclick="openHistoryModal()" class="w-full mb-4 flex items-center justify-center gap-2 bg-white text-slate-600 border border-slate-200 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-50 hover:text-sunny-red hover:border-red-100 transition-all shadow-sm btn-bounce">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                    </button>
                `;
            } else {
                // Guest Mode
                container.innerHTML = `
                    <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-2 bg-white text-slate-600 border border-slate-200 py-3 rounded-xl text-sm font-bold hover:bg-slate-50 hover:text-sunny-red hover:border-red-100 transition-all shadow-sm mb-4 btn-bounce">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Gmail
                    </button>
                    <button onclick="openHistoryModal()" class="w-full mb-4 flex items-center justify-center gap-2 bg-slate-50 text-slate-500 border border-transparent py-2 rounded-xl text-xs font-bold hover:bg-slate-100 transition-all shadow-sm btn-bounce">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Guest)
                    </button>
                `;
            }
        }

        function applyTheme(theme) {
            document.body.classList.remove('theme-christmas');
            let primary = '#E63946', dark = '#1D3557', showScene = 'none';
            if (theme === 'christmas') {
                document.body.classList.add('theme-christmas');
                primary = '#D62828'; dark = '#14532D'; showScene = 'block';
            }
            const scene = document.getElementById('xmas-scene');
            if(scene) scene.style.display = showScene;
            document.querySelector('meta[name="theme-color"]').setAttribute("content", primary);
            document.documentElement.style.setProperty('--sunny-red', primary);
            document.documentElement.style.setProperty('--sunny-dark', dark);
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) return alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö");
            Notification.requestPermission().then(p => {
                if (p === "granted") showToast("‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                else alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
                renderSidebar();
            });
        }

        function checkAndNotifyNews(newsItems) {
            if (!newsItems || newsItems.length === 0) return;
            const latest = [...newsItems].sort((a,b) => b.id - a.id)[0];
            const lastId = parseInt(localStorage.getItem('last_notified_news_id') || '0');
            if (latest.id > lastId) {
                if (Notification.permission === "granted") new Notification("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà", { body: latest.text, icon: "https://via.placeholder.com/128" });
                else showToast("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà: " + latest.text);
                localStorage.setItem('last_notified_news_id', latest.id);
            }
        }

        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Sarabun', 'Inter', 'sans-serif'] }, colors: { 'sunny-red': 'var(--sunny-red)', 'sunny-dark': 'var(--sunny-dark)', 'sunny-bg': '#F1FAEE' } } } }

        // --- RICH TEXT & EMOJI UTILS ---
        const EMOJI_LIST = [
            'üì¢', 'üî•', '‚ú®', 'üéâ', '‚ö†Ô∏è', 'üö®', '‚úÖ', '‚ùå', 'üü¢', 'üî¥', 
            'üìÖ', 'üïí', 'üìå', 'üìç', 'üí°', 'üöö', 'üì¶', 'üéÅ', 'üè∑Ô∏è', 'üõí',
            'üí¨', 'üìû', 'üìß', 'üè†', 'üè¢', 'üõ†Ô∏è', 'üîß', '‚öôÔ∏è', 'üìà', 'üí∞',
            '‚ù§Ô∏è', 'üëç', '‚≠ê', 'üåü', 'üÜï', 'üÜì', 'üÜî', 'üëâ', '‚û°Ô∏è', 'üõë'
        ];

        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
        }

        function insertEmoji(idx, char, type = 'text') {
            const editorId = type === 'badge' ? `badge-edit-${idx}` : `news-edit-${idx}`;
            const pickerId = type === 'badge' ? `emoji-picker-badge-${idx}` : `emoji-picker-${idx}`;
            
            const el = document.getElementById(editorId);
            if(!el) return;
            
            el.focus();
            document.execCommand('insertText', false, char);
            
            const event = new Event('input', { bubbles: true });
            el.dispatchEvent(event);
            
            document.getElementById(pickerId).classList.add('hidden');
        }
    </script>
    <style>
        /* CORE STYLES */
        :root { --sunny-red: #E63946; --sunny-dark: #1D3557; }
        .loader { border-top-color: var(--sunny-red); animation: spin 1s infinite linear; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .wooden-pattern { background-image: repeating-linear-gradient(180deg, rgba(210, 180, 140, 0.05) 0px, rgba(210, 180, 140, 0.05) 15px, rgba(0, 0, 0, 0.02) 16px, transparent 16px, transparent 24px); }
        .header-custom-bg { position: relative; min-height: 280px; }
        @media (min-width: 768px) { .header-custom-bg { min-height: 380px; } }
        .bg-slideshow-container { position: absolute; inset: 0; width: 100%; height: 100%; overflow: hidden; border-radius: 2rem; z-index: 0; }
        .bg-slide-item { position: absolute; inset: 0; width: 100%; height: 100%; background-size: cover; background-position: center center; opacity: 0; transition: opacity 2.5s ease-in-out; }
        .bg-slide-item.active { opacity: 1; transform: scale(1.05); transition: opacity 2.5s ease-in-out, transform 10s linear; }
        .header-custom-bg::after { display: none; }
        
        .header-content-glass { 
            background: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(8px); 
            padding: 1rem 1.5rem; 
            border-radius: 1.25rem; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); 
            display: inline-block; 
            max-width: 100%; 
            border: 1px solid rgba(255,255,255,0.4); 
            position: relative; 
            z-index: 20; 
        }
        @media (max-width: 768px) { 
            .header-content-glass { width: auto; max-width: 90%; margin: 0 auto; display: inline-block; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); } 
            .header-content-glass h1 { font-size: 1.5rem !important; } 
            .header-content-glass h2 { font-size: 0.65rem !important; margin-bottom: 0.25rem !important; } 
        }
        
        #headerSection > div.relative { z-index: 10; }
        .bento-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .bento-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); }
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .noselect { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        
        .ticker-wrap { width: 100%; height: 7rem; overflow: hidden; position: relative; }
        .ticker-move { display: inline-block; width: 100%; position: absolute; top: 0; left: 0; }
        @keyframes verticalSlide { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        
        @keyframes slideDown { 0% { transform: translate(-50%, -100%); opacity: 0; } 100% { transform: translate(-50%, 20px); opacity: 1; } }
        @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
        .toast-show { animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .toast-hide { animation: fadeOut 0.5s forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #bbb; }
        
        .btn-bounce:active { transform: scale(0.95); }
        [contenteditable]:empty:before { content: attr(placeholder); color: #9ca3af; display: block; }
        @keyframes gradient-xy { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .animate-gradient-xy { background-size: 200% 200%; animation: gradient-xy 15s ease infinite; }
        
        /* THEME CHRISTMAS */
        body.theme-christmas { background: linear-gradient(135deg, #fef2f2 0%, #fff1f2 100%) !important; background-image: radial-gradient(#ef4444 0.5px, transparent 0.5px), radial-gradient(#ef4444 0.5px, #fef2f2 0.5px) !important; background-size: 20px 20px !important; color: #1e293b; }
        body.theme-christmas::-webkit-scrollbar-thumb { background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #ffffff 10px, #ffffff 20px); border-radius: 4px; border: 2px solid white; }
        body.theme-christmas #headerSection:not(.header-custom-bg) { background: linear-gradient(to right, #dc2626, #b91c1c) !important; border: 4px solid #fecaca !important; box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.4) !important; }
        body.theme-christmas #headerSection:not(.header-custom-bg) h1, body.theme-christmas #headerSection:not(.header-custom-bg) h2, body.theme-christmas #headerSection:not(.header-custom-bg) span { color: white !important; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        body.theme-christmas #headerSection:not(.header-custom-bg) #productTypeLabel { color: #fef08a !important; font-style: italic; }
        body.theme-christmas #headerSection:not(.header-custom-bg) .bg-green-50 { background-color: rgba(255,255,255,0.2) !important; color: white !important; border-color: rgba(255,255,255,0.3) !important; }
        body.theme-christmas .bento-card { background: white !important; border: 2px solid #bbf7d0 !important; }
        body.theme-christmas .bento-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #ffffff 10px, #ffffff 20px); z-index: 10; }
        body.theme-christmas .bento-card::after { content: 'üéÄ'; position: absolute; top: 5px; right: 5px; font-size: 16px; opacity: 0.8; }
        body.theme-christmas button#searchButton { background: linear-gradient(to bottom, #16a34a, #15803d) !important; }
        #xmas-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; display: none; }
        .snow-flake { position: absolute; top: -10px; color: #cbd5e1; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
        body.theme-christmas .ground, body.theme-christmas .el-tree, body.theme-christmas .el-fire, body.theme-christmas .el-snowman, body.theme-christmas .el-santa { display: none !important; }
        
        @media print { body * { visibility: hidden; } #quotationModal, #quotationModal * { visibility: visible; } #quotationModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; z-index: 9999; } .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-gradient-to-br from-rose-50 via-slate-50 to-indigo-100 animate-gradient-xy h-[100dvh] font-sans text-slate-800 flex overflow-hidden noselect">

    <div id="intro-splash" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-700 ease-out">
        <h1 class="text-6xl font-black text-sunny-red italic tracking-tighter">SUNNY</h1>
        <p class="text-sm font-bold text-slate-400 mt-4 tracking-widest">STOCK SYSTEM</p>
    </div>
    
    <div id="xmas-scene"></div>
    
    <div id="toast" class="fixed top-0 left-1/2 -translate-x-1/2 z-[200] opacity-0 pointer-events-none bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span id="toast-message" class="text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></div>

    <!-- Install Guide Modal -->
    <div id="installGuideModal" class="hidden fixed inset-0 z-[1000] bg-slate-900/60 backdrop-blur-sm flex flex-col justify-end md:justify-center p-4 animate-fade-in-up" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-t-2xl md:rounded-2xl p-6 shadow-2xl pb-10 md:pb-6 relative max-w-sm mx-auto w-full" onclick="event.stopPropagation()">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-4 md:hidden"></div>
            <div class="flex justify-between items-start mb-4">
                <div><h3 id="installGuideTitle" class="font-bold text-lg text-slate-800">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û</h3><p class="text-xs text-slate-400">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô</p></div>
                <button onclick="document.getElementById('installGuideModal').classList.add('hidden')" class="bg-slate-100 p-1.5 rounded-full text-slate-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div id="installInstructions" class="space-y-4 text-sm text-slate-600"></div>
            <button onclick="document.getElementById('installGuideModal').classList.add('hidden')" class="mt-6 w-full py-3 bg-sunny-red text-white rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 btn-bounce">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl animate-fade-in-up">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl z-10">
                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <span class="text-xl">üìú</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
                </h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition-colors">‚úï</button>
            </div>
            <div id="user-history-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-50 custom-scrollbar"></div>
        </div>
    </div>

    <!-- Help Modal (NEW FIX) -->
    <div id="helpModal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl animate-fade-in-up overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-6 bg-sunny-red text-white flex justify-between items-start">
                <div>
                    <h3 class="font-bold text-xl mb-1">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                    <p class="text-red-100 text-xs">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</p>
                </div>
                <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="text-red-100 hover:text-white bg-white/10 hover:bg-white/20 rounded-lg p-1 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <div class="space-y-2">
                    <h4 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-6 h-6 rounded-lg bg-red-50 text-sunny-red flex items-center justify-center text-xs">1</span> ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</h4>
                    <p class="text-sm text-slate-500 ml-8">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ï‡πá‡∏°‡∏Å‡πá‡πÑ‡∏î‡πâ) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</p>
                </div>
                <div class="space-y-2">
                    <h4 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-6 h-6 rounded-lg bg-red-50 text-sunny-red flex items-center justify-center text-xs">2</span> ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</h4>
                    <p class="text-sm text-slate-500 ml-8">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤" ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                </div>
                <div class="space-y-2">
                    <h4 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-6 h-6 rounded-lg bg-red-50 text-sunny-red flex items-center justify-center text-xs">3</span> ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h4>
                    <p class="text-sm text-slate-500 ml-8">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ô Cloud)</p>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="w-full py-2 bg-slate-800 text-white rounded-xl font-bold hover:bg-black transition-colors">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-xs text-center animate-fade-in-up">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <p class="text-slate-500 text-sm mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-2">
                <button onclick="document.getElementById('confirmModal').classList.add('hidden')" class="flex-1 py-2.5 text-slate-500 bg-slate-100 rounded-xl hover:bg-slate-200 font-bold text-sm transition-colors btn-bounce">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirmDeleteBtn" class="flex-1 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 font-bold text-sm shadow-lg shadow-red-200 transition-colors btn-bounce">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <!-- UI Components -->
    <button onclick="toggleSidebar()" class="md:hidden fixed top-3 left-3 z-50 bg-white/90 backdrop-blur p-2.5 rounded-xl shadow-lg border border-slate-100 text-slate-600 active:scale-95 transition-transform flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        <span class="text-xs font-bold text-slate-700">‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-white shadow-2xl transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out border-r border-slate-100 flex flex-col h-full">
        <div class="p-6 border-b border-slate-100 flex items-center gap-3 pt-12 md:pt-6">
            <div class="w-10 h-10 bg-sunny-red rounded-lg flex items-center justify-center text-white font-black italic text-xl shadow-red-200 shadow-lg shrink-0">S</div>
            <div><h1 class="font-black text-xl text-sunny-red italic tracking-tighter" id="app-title-display">SUNNY</h1><p class="text-[10px] text-slate-400 uppercase tracking-widest">Stock & Calc</p></div>
            <button onclick="toggleSidebar()" class="md:hidden ml-auto text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="sidebar-menu-container"></nav>
        <div class="p-6 border-t border-slate-100 space-y-3">
             <!-- User Profile Section -->
             <div id="user-profile-section">
                 <!-- Populated by JS -->
             </div>
             
             <button id="pwaInstallBtn" class="hidden w-full flex items-center justify-center gap-2 bg-slate-800 text-white py-3 rounded-xl text-sm font-bold hover:bg-black transition-colors mb-2 btn-bounce ring-2 ring-offset-2 ring-slate-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û (Install)
            </button>
             <button onclick="requestNotificationPermission()" class="w-full flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-3 rounded-xl text-sm font-bold hover:bg-blue-100 transition-all hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 btn-bounce mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg> <span id="notifBtnText">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
            </button>
             <button onclick="document.getElementById('helpModal').classList.remove('hidden')" class="w-full flex items-center justify-center gap-2 bg-slate-100 text-slate-600 py-3 rounded-xl text-sm font-bold hover:bg-slate-200 transition-all hover:shadow-sm btn-bounce">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
             <button onclick="checkAdminLogin()" class="w-full flex items-center justify-center gap-2 text-slate-300 hover:text-sunny-red py-2 rounded-xl text-xs transition-colors">Admin Mode</button>
        </div>
    </aside>
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <main class="flex-1 md:ml-72 h-full overflow-y-auto overflow-x-hidden scrolling-touch relative">
        <div class="p-4 pt-16 md:p-8 pb-40 max-w-6xl mx-auto space-y-6">
            <div id="headerSection" class="bg-white rounded-[2rem] p-6 md:p-8 shadow-sm border border-slate-100 wooden-pattern relative overflow-hidden hover:shadow-lg transition-all duration-500 ease-in-out">
                <div class="absolute top-0 right-0 w-48 h-48 bg-red-50 rounded-full blur-3xl -mr-16 -mt-16 opacity-60 pointer-events-none"></div>
                <div id="headerContentWrapper" class="relative z-10 transition-all duration-300">
                    <h2 id="systemTitle" class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
                    <h1 class="text-2xl md:text-4xl font-black text-slate-800 tracking-tight leading-tight">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<span class="text-sunny-red italic block md:inline" id="productTypeLabel">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></h1>
                    <div class="mt-2 flex flex-wrap items-center gap-2">
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[10px] font-bold border border-green-100 shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>Online</span>
                        <span class="text-slate-400 text-[10px]">Updated: <span id="lastUpdateDisplay" class="font-semibold text-slate-600">...</span></span>
                        <button id="headerInstallBtn" onclick="installApp()" class="hidden md:hidden inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-800 text-white text-[10px] font-bold border border-slate-700 shadow-sm animate-pulse hover:bg-black transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û</span></button>
                    </div>
                </div>
            </div>

            <div id="news-container" class="space-y-3 hidden">
                <div id="pinned-news-wrapper" class="space-y-3"></div>
                <div id="scrolling-news-wrapper" class="bg-white border border-slate-200 rounded-xl shadow-sm relative overflow-hidden h-28 hidden">
                    <div class="absolute inset-x-0 top-0 h-4 bg-gradient-to-b from-white to-transparent z-10 pointer-events-none"></div>
                    <div class="absolute inset-x-0 bottom-0 h-4 bg-gradient-to-t from-white to-transparent z-10 pointer-events-none"></div>
                    <div id="news-ticker-track" class="ticker-move p-2"></div>
                </div>
            </div>

            <div id="searchSection" class="animate-fade-in-up">
                <div class="relative max-w-xl mx-auto mb-8">
                    <input type="text" id="productCodeInput" autocomplete="off" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="w-full bg-white border-2 border-slate-100 rounded-2xl py-4 pl-12 pr-4 text-lg font-bold text-slate-700 placeholder-slate-300 focus:outline-none focus:border-sunny-red focus:ring-4 focus:ring-red-50 transition-all shadow-sm">
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-6 w-6 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <button id="searchButton" onclick="searchProduct()" class="absolute right-2 top-2 bottom-2 bg-sunny-red text-white px-6 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition-all active:scale-95 btn-bounce">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <div id="suggestion-box" class="absolute top-full left-0 right-0 bg-white border border-slate-100 rounded-xl shadow-2xl mt-2 z-[60] max-h-80 overflow-y-auto hidden custom-scrollbar divide-y divide-slate-50"></div>
                    <div id="codeListModal" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl border border-slate-100 z-50 max-h-60 overflow-y-auto custom-scrollbar p-2"><div id="browseListContainer"></div></div>
                </div>
                <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center py-12"><span class="loader w-10 h-10 border-4 border-slate-200 border-t-sunny-red rounded-full mb-4"></span><span class="text-slate-400 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></div>
                <div id="errorMessage" class="hidden text-center py-10 bg-white rounded-3xl border border-red-100 shadow-sm mx-auto max-w-sm"><div class="w-16 h-16 bg-red-50 text-red-400 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">ü§∑‚Äç‚ôÇÔ∏è</div><h3 class="text-red-500 font-bold text-lg mb-1">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><p id="errorText" class="text-slate-400 text-sm">‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p></div>
                <div id="initialMessage" class="text-center py-12 opacity-60"><div class="w-20 h-20 bg-slate-100 text-slate-300 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üîç</div><p class="text-slate-400 font-medium">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p><button onclick="toggleCodeListModal(true)" class="mt-2 text-sunny-red text-sm font-bold hover:underline">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></div>
                <div id="productCard" class="hidden animate-fade-in-up">
                    <div class="bg-white rounded-[2rem] p-6 md:p-8 shadow-xl border border-slate-100 relative overflow-hidden mb-6">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-slate-50 rounded-full -mr-10 -mt-10 z-0"></div>
                        <div class="relative z-10">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-slate-100 pb-6"><div><span class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold tracking-wider mb-2 inline-block">CODE</span><h2 id="productCodeDisplay" class="text-4xl md:text-5xl font-black text-slate-800 tracking-tight"></h2><p id="productName" class="text-slate-500 text-lg mt-1 font-medium"></p></div><div class="text-right"><div class="text-sm text-slate-400 font-bold mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="inline-flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 rounded-xl font-bold border border-green-100"><span class="w-2 h-2 rounded-full bg-green-500"></span> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</div></div></div>
                            <div id="stockGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="calculatorSection" class="hidden animate-fade-in-up">
                <div class="bg-white rounded-[2rem] p-6 md:p-8 shadow-xl border border-slate-100">
                    <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4"><div class="w-12 h-12 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-2xl shadow-sm" id="calcTitleIcon">ü™ü</div><div><h2 class="text-2xl font-black text-slate-800" id="calcTitleText">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</h2><p class="text-xs text-slate-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</p></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                         <div class="space-y-4">
                            <div><label class="block text-sm font-bold text-slate-600 mb-1">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (W)</label><input type="number" id="calcW" class="w-full p-3 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:border-sunny-red focus:ring-4 focus:ring-red-50 font-bold text-lg" placeholder="0.00"></div>
                            <div><label class="block text-sm font-bold text-slate-600 mb-1">‡∏™‡∏π‡∏á (H)</label><input type="number" id="calcH" class="w-full p-3 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:border-sunny-red focus:ring-4 focus:ring-red-50 font-bold text-lg" placeholder="0.00"></div>
                            <div><label class="block text-sm font-bold text-slate-600 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><div class="flex bg-slate-100 p-1 rounded-xl"><button id="btnUnitM" onclick="setCalcUnit('m')" class="flex-1 px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-sunny-red">‡πÄ‡∏°‡∏ï‡∏£ (m)</button><button id="btnUnitCM" onclick="setCalcUnit('cm')" class="flex-1 px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 transition-all">‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£ (cm)</button></div></div>
                         </div>
                         <div class="space-y-4">
                            <div><label class="block text-sm font-bold text-slate-600 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏£.‡∏•.</label><input type="number" id="calcPrice" class="w-full p-3 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:border-sunny-red focus:ring-4 focus:ring-red-50 font-bold text-lg" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤"></div>
                            <div><label class="block text-sm font-bold text-slate-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏∏‡∏î)</label><input type="number" id="calcQty" value="1" class="w-full p-3 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:border-sunny-red focus:ring-4 focus:ring-red-50 font-bold text-lg"></div>
                            <button onclick="addCalcItem()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-black transition-all btn-bounce mt-4">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                         </div>
                    </div>
                    <div class="bg-slate-50 rounded-2xl p-4 overflow-hidden border border-slate-100"><table class="w-full text-sm"><thead class="text-xs text-slate-400 uppercase bg-slate-100 border-b border-slate-200"><tr><th class="px-3 py-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="px-3 py-2 text-left">‡∏Ç‡∏ô‡∏≤‡∏î</th><th class="px-3 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏∏‡∏î</th><th class="px-3 py-2 text-right">‡∏£‡∏ß‡∏°</th><th class="px-3 py-2"></th></tr></thead><tbody id="calcTableBody" class="text-slate-600"></tbody><tfoot class="font-bold text-slate-800 bg-white border-t border-slate-200"><tr><td colspan="3" class="px-3 py-3 text-right">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="totalItems">0</span> ‡∏ä‡∏∏‡∏î)</td><td class="px-3 py-3 text-right text-lg text-sunny-red" id="grandTotal">0.00</td><td></td></tr></tfoot></table></div>
                    <div class="mt-4 flex gap-2"><button onclick="clearCalc()" class="px-4 py-2 text-red-400 hover:text-red-600 font-bold text-sm bg-red-50 rounded-xl transition-colors">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button onclick="showQuotationModal()" class="flex-1 px-4 py-2 bg-sunny-red text-white font-bold text-sm rounded-xl shadow-lg shadow-red-200 hover:bg-red-700 transition-colors btn-bounce">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button></div>
                </div>
            </div>
            <div class="text-center text-slate-300 text-[10px] mt-8 font-mono no-print">POWERED BY SUNNY 1988</div>
        </div>
    </main>

    <!-- Admin & Config Modals -->
    <div id="adminLoginModal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in-up"><h3 class="text-xl font-bold text-slate-800 mb-4 text-center">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3><input type="password" id="adminPassword" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 mb-4 focus:ring-2 focus:ring-sunny-red focus:outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô..."><p id="loginError" class="text-red-500 text-xs mb-4 text-center hidden">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p><div class="flex gap-2"><button onclick="closeAdminLogin()" class="flex-1 py-2 text-slate-400 font-bold text-sm bg-slate-100 rounded-xl hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="handleLogin()" class="flex-1 py-2 bg-sunny-red text-white font-bold text-sm rounded-xl hover:bg-red-700 shadow-lg shadow-red-200">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div></div></div>
    <div id="adminConfigModal" class="hidden fixed inset-0 z-[100] bg-white flex flex-col"><div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white shadow-sm z-10"><h2 class="text-lg font-black text-slate-800 flex items-center gap-2"><span class="text-sunny-red">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2><div class="flex items-center gap-2"><span id="admin-mode-status" class="text-xs font-bold text-green-600 mr-2">Online</span><button onclick="saveConfig()" class="bg-sunny-red text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-red-200 hover:bg-red-700 btn-bounce">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="closeConfig()" class="text-slate-400 hover:text-slate-600 px-2 text-xl">‚úï</button></div></div><div class="flex border-b border-slate-200 overflow-x-auto"><button id="tab-btn-menu" onclick="switchAdminTab('menu')" class="px-4 py-3 text-sm font-bold border-b-2 border-sunny-red text-sunny-red bg-red-50 whitespace-nowrap">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</button><button id="tab-btn-news" onclick="switchAdminTab('news')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</button><button id="tab-btn-calc" onclick="switchAdminTab('calc')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button><button id="tab-btn-saved" onclick="switchAdminTab('saved')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button><button id="tab-btn-theme" onclick="switchAdminTab('theme')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡∏ò‡∏µ‡∏°</button><button id="tab-btn-features" onclick="switchAdminTab('features')" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">Features</button></div><div class="flex-1 overflow-y-auto p-4 bg-slate-50 custom-scrollbar"><div id="tab-content-menu" class="space-y-4 max-w-2xl mx-auto"><div class="bg-white p-4 rounded-xl border border-slate-200"><label class="block text-xs font-bold text-slate-400 uppercase mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</label><input type="text" id="conf-app-title" class="w-full p-2 border rounded font-bold text-lg text-sunny-red"></div><div id="admin-menu-list" class="space-y-3"></div></div><div id="tab-content-news" class="hidden space-y-4 max-w-3xl mx-auto"><div class="bg-white p-4 rounded-xl border border-slate-200 flex items-center justify-between"><div><label class="font-bold text-slate-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á</label><p class="text-xs text-slate-400">1=‡∏ä‡πâ‡∏≤, 5=‡πÄ‡∏£‡πá‡∏ß</p></div><input type="range" id="conf-news-speed" min="1" max="5" class="w-32 accent-sunny-red"></div><button onclick="addNewNewsItem()" class="w-full py-3 bg-white border-2 border-dashed border-slate-300 text-slate-400 font-bold rounded-xl hover:border-sunny-red hover:text-sunny-red transition-all">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà</button><div id="admin-news-list" class="space-y-3"></div></div><div id="tab-content-calc" class="hidden space-y-4 max-w-xl mx-auto"><div class="bg-white p-4 rounded-xl border border-slate-200 flex items-center justify-between"><span class="font-bold text-slate-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span><input type="checkbox" id="conf-calc-enabled" class="w-6 h-6 accent-sunny-red"></div><div class="bg-white p-4 rounded-xl border border-slate-200 space-y-4"><h3 class="font-bold border-b pb-2">‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-slate-400">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ú‡πâ‡∏≤ (Fabric Mult)</label><input type="number" step="0.1" id="factor-fabricMult" class="w-full p-2 border rounded"></div><div><label class="text-xs font-bold text-slate-400">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (Min Area)</label><input type="number" step="0.1" id="factor-minArea" class="w-full p-2 border rounded"></div><div><label class="text-xs font-bold text-slate-400">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (Eq Ext)</label><input type="number" id="factor-eqExt" class="w-full p-2 border rounded"></div><div><label class="text-xs font-bold text-slate-400">‡∏£‡∏≤‡∏á‡∏ö‡∏ô (Rail Top)</label><input type="number" id="factor-railTop" class="w-full p-2 border rounded"></div><div><label class="text-xs font-bold text-slate-400">‡∏£‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á (Rail Bot)</label><input type="number" id="factor-railBot" class="w-full p-2 border rounded"></div><div><label class="text-xs font-bold text-slate-400">‡∏™‡∏•‡∏¥‡∏á (Sling)</label><input type="number" id="factor-sling" class="w-full p-2 border rounded"></div></div></div></div><div id="tab-content-saved" class="hidden space-y-4 max-w-2xl mx-auto"><div class="text-xs text-slate-400 mb-2">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin View)</div><div id="saved-quotations-list" class="space-y-2"></div></div><div id="tab-content-theme" class="hidden space-y-4 max-w-2xl mx-auto"><div class="grid grid-cols-2 gap-4"><label class="cursor-pointer block"><input type="radio" name="app-theme" value="default" class="peer sr-only" onchange="previewTheme('default')"><div class="p-4 rounded-xl border-2 peer-checked:border-sunny-red peer-checked:bg-red-50 bg-white hover:bg-slate-50 transition-all text-center"><div class="text-2xl mb-2">‚òÄÔ∏è</div><div class="font-bold text-slate-700">Standard</div><div class="text-xs text-slate-400">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div></div></label><label class="cursor-pointer block"><input type="radio" name="app-theme" value="christmas" class="peer sr-only" onchange="previewTheme('christmas')"><div class="p-4 rounded-xl border-2 peer-checked:border-green-500 peer-checked:bg-green-50 bg-white hover:bg-slate-50 transition-all text-center"><div class="text-2xl mb-2">üéÑ</div><div class="font-bold text-green-700">Christmas</div><div class="text-xs text-slate-400">‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™</div></div></label></div></div><div id="tab-content-features" class="hidden space-y-4 max-w-xl mx-auto"><div class="bg-purple-50 p-4 rounded-xl border border-purple-100 mb-4"><h3 class="font-bold text-purple-700 text-sm mb-2">üöÄ Feature Flags (Experimental)</h3><div id="admin-features-list" class="space-y-2"></div></div><div class="flex gap-2"><input type="text" id="new-feature-key" placeholder="Feature Key..." class="flex-1 p-2 border rounded text-sm"><button onclick="addNewFeature()" class="bg-purple-600 text-white px-3 py-2 rounded font-bold text-xs">Add</button></div></div></div><div class="p-4 border-t border-slate-200 bg-white"><button id="logoutBtn" onclick="logoutAdmin()" class="w-full py-3 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200 hidden">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</button></div></div>
    <div id="quotationModal" class="hidden fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white w-full max-w-2xl rounded-none md:rounded-xl shadow-2xl overflow-hidden animate-fade-in-up my-auto">
            <div class="p-8 bg-white" id="quotationContent">
                <div class="flex justify-between items-start mb-8 border-b border-slate-100 pb-6">
                    <div><h1 class="text-3xl font-black text-sunny-red italic tracking-tighter">SUNNY</h1><p class="text-sm text-slate-500 font-bold mt-1">QUOTATION / ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</p></div>
                    <div class="text-right"><div class="text-xs text-slate-400 uppercase font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div class="font-bold text-slate-800" id="qDate"></div><div class="text-xs text-slate-400 uppercase font-bold mt-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div><div class="font-bold text-sunny-red bg-red-50 px-2 py-0.5 rounded" id="qType"></div></div>
                </div>
                <div class="mb-6">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200"><tr><th class="py-3 pl-4 text-left rounded-l-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="py-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏∏‡∏î</th><th class="py-3 pr-4 text-right rounded-r-lg">‡∏£‡∏ß‡∏°</th></tr></thead>
                        <tbody id="qBody" class="text-slate-700 divide-y divide-slate-100"></tbody>
                        <tfoot class="font-bold text-slate-800 border-t-2 border-slate-100"><tr><td colspan="3" class="pt-4 text-right pr-4 text-base">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td><td class="pt-4 text-right text-xl text-sunny-red" id="qGrandTotal"></td></tr></tfoot>
                    </table>
                </div>
                <div id="qDetails" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-100 text-xs text-slate-600 space-y-2 mb-6"><h4 class="font-bold text-slate-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</h4><div id="qDetailContent"></div></div>
                <div class="text-center text-[10px] text-slate-300 font-mono mt-8 border-t border-slate-50 pt-4">Generated by SUNNY STOCK SYSTEM</div>
            </div>
            <div class="bg-slate-50 p-4 flex gap-2 border-t border-slate-200 no-print">
                <button onclick="toggleQDetails()" class="px-4 py-2 text-slate-500 font-bold text-xs bg-white border border-slate-200 rounded-lg hover:bg-slate-100">‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</button>
                <div class="flex-grow"></div>
                <button onclick="saveCurrentQuotation()" class="px-4 py-2 bg-blue-500 text-white font-bold text-xs rounded-lg hover:bg-blue-600 shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button onclick="captureQuotation()" class="px-4 py-2 bg-sunny-red text-white font-bold text-xs rounded-lg hover:bg-red-700 shadow-lg shadow-red-200 flex items-center gap-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button>
                <button onclick="closeQuotation()" class="px-4 py-2 text-slate-400 hover:text-red-500 font-bold text-xs">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        // --- CORE SYSTEM VARIABLES ---
        const WOOD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1132498145&single=true&output=csv";
        const PVC_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1230787558&single=true&output=csv";
        const ROLLER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1019928538&single=true&output=csv";
        const ALU_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1880232984&single=true&output=csv";
        
        const ICONS = {
            wood: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>',
            alu: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>',
            pvc: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>',
            roller: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>'
        };
        
        let currentSystem = 'WOOD'; let cache = { WOOD: null, PVC: null, ROLLER: null, ALU: null };

        function isDateNew(dateStr) { if(!dateStr) return false; return (new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24) < 7; }
        function formatDate(dateStr) { if(!dateStr) return ''; return new Date(dateStr).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }); }
        function isValidCode(c){if(!c||c.includes(',')||c.includes('"')||c.length>20)return false; const b=['SLAT','PCS','BOX','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','NAME','CODE','PRICE','35MM','50MM','F-WOOD','25MM','‡∏£‡∏´‡∏±‡∏™','‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠','‡∏ä‡∏∑‡πà‡∏≠','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á']; return !b.some(w=>c.toUpperCase().includes(w));}

        const STOCK_COLUMNS_WOOD={'4ft':{col:4,meter:'1.22 ‡∏°.'},'4.5ft':{col:6,meter:'1.37 ‡∏°.'},'5ft':{col:8,meter:'1.52 ‡∏°.'},'5.5ft':{col:10,meter:'1.68 ‡∏°.'},'6ft':{col:12,meter:'1.83 ‡∏°.'},'6.5ft':{col:14,meter:'1.98 ‡∏°.'},'7ft':{col:16,meter:'2.13 ‡∏°.'},'8ft':{col:18,meter:'2.44 ‡∏°.'}};
        function parseWoodCSV(t){const l=t.trim().split('\n'),d={};let lc=null;for(let i=2;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(!c&&lc){const h=Object.values(STOCK_COLUMNS_WOOD).some(o=>cr[o.col]&&cr[o.col]!=='0');if(cr[1]||h)c=lc}if(c){c=c.toUpperCase();if(!isValidCode(c))continue;lc=c;if(!d[c]){d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{}};Object.keys(STOCK_COLUMNS_WOOD).forEach(k=>d[c].stocks[k]=0)}for(const[k,o]of Object.entries(STOCK_COLUMNS_WOOD))if(cr.length>o.col)d[c].stocks[k]+=parseInt(cr[o.col].replace(/,/g,'')||0,10)}}return d}
        function parseAluCSV(t){const l=t.trim().split('\n'),d={};for(let i=1;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(c){c=c.toUpperCase();if(!isValidCode(c))continue;const v=parseInt(cr[2].replace(/,/g,'')||0,10);if(!d[c])d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠':v}};else d[c].stocks['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']+=v}}return d}
        function parsePvcCSV(t){const l=t.trim().split('\n'),d={};const hr=l[1].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c=>c.trim().replace(/^"|"$/g,''));const hm=[];for(let i=2;i<hr.length;i++)if(hr[i]&&!isNaN(parseInt(hr[i])))hm.push({index:i,label:hr[i]});for(let i=2;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(c){c=c.toUpperCase();if(!isValidCode(c))continue;if(!d[c])d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{}};hm.forEach(h=>{if(cr.length>h.index)d[c].stocks[h.label]=(d[c].stocks[h.label]||0)+parseInt(cr[h.index].replace(/,/g,'')||0,10)})}}return d}
        function parseRollerCSV(t){const l=t.trim().split('\n'),d={};for(let i=3;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(c){c=c.toUpperCase();if(!isValidCode(c))continue;const v=parseInt(cr[2].replace(/,/g,'')||0,10);if(!d[c])d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠':v}};else d[c].stocks['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']+=v}}return d}

        // --- DATA FETCHING ---
        async function fetchData(sysId) {
            const system = sysId || currentSystem; 
            if (cache[system]) return cache[system];
            let url = (system==='WOOD')?WOOD_CSV_URL:(system==='ALU')?ALU_CSV_URL:(system==='PVC')?PVC_CSV_URL:ROLLER_CSV_URL;
            try {
                const response = await fetch(url, { cache: "no-store" }); if (!response.ok) throw new Error('Network Error');
                const text = await response.text(); let parsedData;
                if (system==='WOOD') parsedData = parseWoodCSV(text); else if (system==='ALU') parsedData = parseAluCSV(text); else if (system==='PVC') parsedData = parsePvcCSV(text); else parsedData = parseRollerCSV(text);
                cache[system] = parsedData; 
                if (currentSystem === system) {
                    document.getElementById('lastUpdateDisplay').innerText = new Date().toLocaleDateString('th-TH', { hour: '2-digit', minute: '2-digit' }) + ' ‡∏ô.'; 
                }
                return parsedData;
            } catch (e) { console.error(e); throw e; }
        }

        async function updateProductList() {
            const activeSystem = currentSystem; 
            const browse = document.getElementById('browseListContainer');
            browse.innerHTML = `<div class="flex justify-center items-center h-full text-slate-400"><span class="loader w-6 h-6 border-2 border-slate-300 border-t-sunny-red rounded-full mr-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
            try {
                const data = await fetchData(activeSystem);
                if (currentSystem !== activeSystem) return;

                const browseContent = document.createDocumentFragment();
                const codes = Object.keys(data).sort();
                if(codes.length===0) { browse.innerHTML = `<div class="text-center text-slate-400 mt-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`; return; }
                
                codes.forEach(code => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left bg-slate-50 hover:bg-red-50 p-4 rounded-xl border border-slate-100 hover:border-red-100 transition-all flex justify-between items-center group btn-bounce mb-2";
                    btn.onclick = () => { document.getElementById('productCodeInput').value = code; toggleCodeListModal(false); searchProduct(); };
                    btn.innerHTML = `<div><span class="block font-bold text-lg text-slate-700 group-hover:text-sunny-red transition-colors">${code}</span></div><svg class="h-5 w-5 text-slate-300 group-hover:text-sunny-red transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`;
                    browseContent.appendChild(btn);
                });
                browse.innerHTML = '';
                browse.appendChild(browseContent);
            } catch (error) { browse.innerHTML = `<div class="text-center text-red-400 mt-10">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }

        // --- SEARCH FUNCTION ---
        async function searchProduct() {
            const input = document.getElementById('productCodeInput'); 
            const code = input.value.trim().toUpperCase(); 
            document.getElementById('suggestion-box').classList.add('hidden');
            if (!code) return;
            
            const ids = ['loadingIndicator', 'productCard', 'errorMessage', 'initialMessage']; 
            ids.forEach(id => document.getElementById(id).classList.add('hidden')); 
            
            document.getElementById('loadingIndicator').classList.remove('hidden'); 
            const btn = document.getElementById('searchButton'); 
            btn.disabled = true; 
            btn.innerHTML = '<span class="loader block w-5 h-5 border-2 border-white/50 border-t-white rounded-full"></span>';
            
            try {
                const data = await fetchData(currentSystem); 
                const result = data[code];
                document.getElementById('loadingIndicator').classList.add('hidden'); 
                btn.disabled = false; 
                btn.innerText = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                
                if (result) {
                    document.getElementById('productCodeDisplay').innerText = code; 
                    document.getElementById('productName').innerText = result.name;
                    const grid = document.getElementById('stockGrid'); 
                    grid.innerHTML = '';
                    const isSingle = currentSystem === 'ROLLER' || currentSystem === 'ALU';
                    grid.className = isSingle ? 'grid grid-cols-1 gap-4 pb-4 max-w-sm mx-auto' : 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 pb-4';
                    
                    const createCard = (label, sub, qty) => {
                        const isZero = qty === 0, isLow = qty > 0 && qty < 20;
                        return `<div class="bento-card relative rounded-2xl p-4 border flex flex-col justify-between ${isSingle?'h-40 items-center justify-center text-center':'h-28'} ${isZero?'bg-slate-50 opacity-60 text-slate-400':(isLow?'bg-white border-red-200 ring-1 ring-red-100 text-red-600':'bg-white text-slate-800')} shadow-sm group">
                            <div class="${isSingle?'w-full flex justify-between mb-2':'flex justify-between items-start'}"><div><span class="font-bold text-base md:text-lg">${label}</span>${sub?`<span class="block text-[10px] bg-slate-100 px-1.5 rounded-md w-fit mt-0.5 ${isSingle?'mx-auto':''}">${sub}</span>`:''}</div><div class="rounded-full p-1 ${isZero?'bg-red-100 text-red-400':(isLow?'bg-red-500 text-white':'bg-green-500 text-white')}"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="${isZero?'M6 18L18 6M6 6l12 12':'M5 13l4 4L19 7'}"></path></svg></div></div>
                            <div class="${isSingle?'text-center mt-2':'text-right'}"><span class="block ${isSingle?'text-5xl':'text-3xl'} font-black tracking-tight leading-none">${qty.toLocaleString()}</span>${isSingle?'<span class="text-sm text-slate-400 mt-1 block">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>':''}</div></div>`;
                    };

                    if(currentSystem==='WOOD') Object.keys(STOCK_COLUMNS_WOOD).forEach(k => grid.innerHTML+=createCard(k, STOCK_COLUMNS_WOOD[k].meter, result.stocks[k]));
                    else if(currentSystem==='PVC') Object.keys(result.stocks).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(k => grid.innerHTML+=createCard(`‡∏™‡∏π‡∏á ${k}`, '‡∏ã‡∏°.', result.stocks[k]));
                    else grid.innerHTML += createCard('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '', result.stocks['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']);
                    document.getElementById('productCard').classList.remove('hidden');
                } else {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    document.getElementById('errorText').innerText = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™: ${code} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ${appConfig.menus.find(m=>m.id===currentSystem).name}`;
                }
            } catch (error) { 
                console.error(error); 
                document.getElementById('loadingIndicator').classList.add('hidden'); 
                btn.disabled = false; 
                btn.innerText = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'; 
                document.getElementById('errorMessage').classList.remove('hidden'); 
                document.getElementById('errorText').innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'; 
            }
        }

        // --- AUTOCOMPLETE LOGIC ---
        function setupAutocomplete() {
            const input = document.getElementById('productCodeInput');
            const box = document.getElementById('suggestion-box');
            if(!input || !box) return; 

            const showSuggestions = () => {
                const val = input.value.trim().toUpperCase();
                const data = cache[currentSystem];
                if (!data) return;

                const codes = Object.keys(data).sort();
                let matches = [];
                
                if (!val) {
                    matches = codes.slice(0, 50);
                } else {
                    const starts = codes.filter(c => c.startsWith(val));
                    const includes = codes.filter(c => !c.startsWith(val) && c.includes(val));
                    matches = [...starts, ...includes].slice(0, 50);
                }

                if (matches.length === 0) {
                    box.classList.add('hidden');
                    return;
                }

                let html = '';
                matches.forEach(code => {
                    const name = data[code].name || '';
                    const displayCode = val ? code.replace(val, `<span class="text-sunny-red bg-red-50">${val}</span>`) : code;
                    
                    html += `
                        <div class="p-3 hover:bg-red-50 cursor-pointer flex justify-between items-center transition-colors group" onclick="selectSuggestion('${code}')">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-300 group-hover:bg-sunny-red transition-colors"></span>
                                <span class="font-bold text-slate-700 text-lg">${displayCode}</span>
                            </div>
                            <span class="text-xs text-slate-400 font-normal bg-slate-50 px-2 py-1 rounded-lg border border-slate-100 group-hover:border-red-100 group-hover:text-sunny-red transition-colors">${name}</span>
                        </div>
                    `;
                });
                
                box.innerHTML = html;
                box.classList.remove('hidden');
            };

            input.addEventListener('input', showSuggestions);
            input.addEventListener('focus', showSuggestions);
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !box.contains(e.target)) {
                    box.classList.add('hidden');
                }
            });
        }

        function selectSuggestion(code) {
            const input = document.getElementById('productCodeInput');
            input.value = code;
            document.getElementById('suggestion-box').classList.add('hidden');
            searchProduct();
        }

        // --- BACKGROUND SLIDESHOW ---
        let slideshowInterval = null; 
        function switchSystem(system) {
            currentSystem = system;
            document.getElementById('searchSection').classList.remove('hidden');
            document.getElementById('calculatorSection').classList.add('hidden');
            
            const menu = appConfig.menus.find(m => m.id === system);
            if(!menu) return;
            
            document.getElementById('systemTitle').innerText = "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å " + menu.name;
            document.getElementById('productTypeLabel').innerText = menu.name;
            
            const header = document.getElementById('headerSection');
            const headerContent = document.getElementById('headerContentWrapper');
            
            if (slideshowInterval) clearInterval(slideshowInterval);
            const oldSlides = header.querySelector('.bg-slideshow-container');
            if (oldSlides) oldSlides.remove();
            
            if (menu.bgImage && menu.bgImage.trim() !== '') {
                const images = menu.bgImage.split(',').map(url => url.trim()).filter(url => url !== '').slice(0, 4);
                
                header.classList.add('header-custom-bg');
                header.classList.remove('wooden-pattern');
                headerContent.classList.add('header-content-glass');
                header.style.backgroundImage = '';
                
                const slideContainer = document.createElement('div');
                slideContainer.className = 'bg-slideshow-container';
                
                images.forEach((url, index) => {
                    const slide = document.createElement('div');
                    slide.className = `bg-slide-item ${index === 0 ? 'active' : ''}`;
                    slide.style.backgroundImage = `url('${url}')`;
                    slideContainer.appendChild(slide);
                });
                
                header.insertBefore(slideContainer, header.firstChild);
                
                if (images.length > 1) {
                    let currentSlide = 0;
                    const slides = slideContainer.querySelectorAll('.bg-slide-item');
                    slideshowInterval = setInterval(() => {
                        slides[currentSlide].classList.remove('active');
                        currentSlide = (currentSlide + 1) % slides.length;
                        slides[currentSlide].classList.add('active');
                    }, 5000); 
                }
            } else {
                header.style.backgroundImage = '';
                header.classList.remove('header-custom-bg');
                header.classList.add('wooden-pattern');
                headerContent.classList.remove('header-content-glass');
            }
            
            document.getElementById('productCodeInput').value = '';
            document.getElementById('productCodeInput').placeholder = system==='WOOD'?'‡πÄ‡∏ä‡πà‡∏ô B35-34...':system==='PVC'?'‡πÄ‡∏ä‡πà‡∏ô 926...':system==='ALU'?'‡πÄ‡∏ä‡πà‡∏ô 001...':'‡πÄ‡∏ä‡πà‡∏ô SZH...';
            document.getElementById('productCard').classList.add('hidden');
            document.getElementById('initialMessage').classList.remove('hidden');
            const sb = document.getElementById('suggestion-box'); if(sb) sb.classList.add('hidden');
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }
            updateProductList();
        }

        function renderNews() {
            const container = document.getElementById('news-container');
            const pinnedWrapper = document.getElementById('pinned-news-wrapper');
            const scrollWrapper = document.getElementById('scrolling-news-wrapper');
            const scrollTrack = document.getElementById('news-ticker-track');
            
            const news = appConfig.newsItems || [];
            if(news.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            
            const pinnedItems = news.filter(n => n.pinned);
            const scrollItems = news.filter(n => !n.pinned);
            
            pinnedWrapper.innerHTML = '';
            pinnedItems.forEach(item => {
                const isNew = isDateNew(item.date);
                const el = document.createElement('div');
                el.className = "bg-gradient-to-r from-red-50 to-white border border-red-100 p-3 rounded-xl shadow-sm flex items-start gap-3 relative overflow-hidden transition-all hover:shadow-md hover:-translate-y-0.5";
                el.innerHTML = `
                    <div class="absolute top-0 left-0 w-1 h-full bg-sunny-red"></div>
                    <div class="text-sunny-red mt-0.5"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg></div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                            ${isNew ? `<span class="px-1.5 py-0.5 rounded text-[10px] font-bold shadow-sm" style="background-color: ${item.badgeColor}; color: ${item.badgeTextColor}">${item.badgeLabel}</span>` : ''}
                            <span class="text-[10px] text-slate-400 font-medium bg-white px-1.5 rounded border border-slate-100">${formatDate(item.date)}</span>
                        </div>
                        <p class="text-sm font-semibold whitespace-normal break-words leading-relaxed" style="color: ${item.textColor}">${item.text}</p>
                    </div>`;
                pinnedWrapper.appendChild(el);
            });
            
            if (scrollItems.length > 0) {
                scrollWrapper.classList.remove('hidden');
                scrollTrack.innerHTML = '';
                const createItem = (item) => `
                    <div class="h-28 flex items-center gap-3 px-2 w-full shrink-0 hover:bg-slate-50/50 transition-colors">
                        <div class="flex-1 min-w-0 flex flex-col justify-center h-full">
                            <div class="flex items-center gap-2 mb-0.5">
                                ${isDateNew(item.date) ? `<span class="px-1.5 py-0.5 rounded-[4px] text-[9px] font-bold" style="background-color: ${item.badgeColor}; color: ${item.badgeTextColor}">${item.badgeLabel}</span>` : ''}
                                <span class="text-[10px] text-slate-400">${formatDate(item.date)}</span>
                            </div>
                            <div class="text-sm font-medium whitespace-normal break-words leading-snug line-clamp-4" style="color: ${item.textColor}">${item.text}</div>
                        </div>
                    </div>`;
                
                let html = '';
                scrollItems.forEach(item => html += createItem(item));
                if (scrollItems.length > 0) scrollItems.forEach(item => html += createItem(item));
                
                scrollTrack.innerHTML = html;
                const speedVal = appConfig.newsSettings.speed || 3;
                const totalDuration = (6 - speedVal) * scrollItems.length;
                scrollTrack.style.animation = `verticalSlide ${totalDuration}s linear infinite`;
            } else {
                scrollWrapper.classList.add('hidden');
            }
        }

        // --- CALCULATOR LOGIC ---
        let calcMode = 'EXT';
        let calcUnit = 'm';
        let calcItems = [];
        
        function setCalcUnit(u) {
            calcUnit = u;
            document.getElementById('btnUnitM').className = u==='m' ? "px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-sunny-red btn-bounce" : "px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 transition-all btn-bounce";
            document.getElementById('btnUnitCM').className = u==='cm' ? "px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-sunny-red btn-bounce" : "px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 transition-all btn-bounce";
        }
        
        function switchCalcMode(mode) {
            // Function triggered by Sidebar Menu
            openCalculator(mode);
            toggleSidebar();
        }

        function openCalculator(mode) {
            // Core logic to switch view
            calcMode = mode;
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('calculatorSection').classList.remove('hidden');
            document.getElementById('calcTitleText').innerText = mode === 'EXT' ? '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' : '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô';
            document.getElementById('calcTitleIcon').innerText = mode === 'EXT' ? 'ü™ü' : 'üè†';
            renderCalcTable(); // Ensure table is rendered
        }
        
        function addCalcItem() {
            const wInput = parseFloat(document.getElementById('calcW').value);
            const hInput = parseFloat(document.getElementById('calcH').value);
            const price = parseFloat(document.getElementById('calcPrice').value);
            const qty = parseInt(document.getElementById('calcQty').value) || 1;
            
            if(!wInput || !hInput || !price) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
            
            const w = calcUnit === 'cm' ? wInput/100 : wInput;
            const h = calcUnit === 'cm' ? hInput/100 : hInput;
            const f = appConfig.calcSettings.factors;
            
            let rawArea = w * h * f.fabricMult;
            let finalArea = rawArea < f.minArea ? f.minArea : rawArea;
            let fabricCost = finalArea * price;
            let totalPerSet = 0;
            let details = ``;
            
            if(calcMode === 'EXT') {
                const topRail = w * f.railTop;
                const botRail = w * f.railBot;
                const sling = h * f.sling * 2;
                totalPerSet = fabricCost + f.eqExt + topRail + botRail + sling;
                details = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤: ${w.toFixed(2)}x${h.toFixed(2)}x${f.fabricMult} = ${rawArea.toFixed(2)} ${rawArea<f.minArea?`(‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${f.minArea})`:''} x ${price} = ${fabricCost.toLocaleString()} ‡∏ö.<br>‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${f.eqExt.toLocaleString()} ‡∏ö.<br>‡∏£‡∏≤‡∏á‡∏ö‡∏ô: ${w.toFixed(2)}x${f.railTop} = ${topRail.toLocaleString()} ‡∏ö.<br>‡∏£‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á: ${w.toFixed(2)}x${f.railBot} = ${botRail.toLocaleString()} ‡∏ö.<br>‡∏™‡∏•‡∏¥‡∏á: ${h.toFixed(2)}x${f.sling}x2 = ${sling.toLocaleString()} ‡∏ö.`;
            } else {
                totalPerSet = fabricCost;
                details = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤: ${w.toFixed(2)}x${h.toFixed(2)}x${f.fabricMult} = ${rawArea.toFixed(2)} ${rawArea<f.minArea?`(‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${f.minArea})`:''} x ${price} = ${fabricCost.toLocaleString()} ‡∏ö.`;
            }
            
            const grandTotal = totalPerSet * qty;
            calcItems.push({ w: wInput, h: hInput, unit: calcUnit, price: price, qty: qty, totalPerSet: totalPerSet, grandTotal: grandTotal, details: details });
            renderCalcTable();
            document.getElementById('calcW').value = '';
            document.getElementById('calcH').value = '';
        }
        
        function renderCalcTable() {
            const tbody = document.getElementById('calcTableBody');
            tbody.innerHTML = '';
            let sum = 0;
            calcItems.forEach((item, idx) => {
                sum += item.grandTotal;
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors">
                        <td class="px-3 py-3 font-bold">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${idx+1}</td>
                        <td class="px-3 py-3 text-slate-500">${item.w}x${item.h} ${item.unit}</td>
                        <td class="px-3 py-3 text-right">${item.totalPerSet.toLocaleString()}</td>
                        <td class="px-3 py-3 text-right font-bold">${item.grandTotal.toLocaleString()}</td>
                        <td class="px-3 py-3 text-right"><button onclick="removeCalcItem(${idx})" class="text-red-300 hover:text-red-500 btn-bounce">x</button></td>
                    </tr>`;
            });
            document.getElementById('totalItems').innerText = calcItems.length;
            document.getElementById('grandTotal').innerText = sum.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        function removeCalcItem(idx) { calcItems.splice(idx, 1); renderCalcTable(); }
        
        function clearCalc() { 
            calcItems = []; 
            currentEditingId = null;
            currentEditingDocId = null;
            renderCalcTable(); 
        }

        // --- QUOTATION ---
        function showQuotationModal() {
            if(calcItems.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì'); return; }
            document.getElementById('quotationModal').classList.remove('hidden');
            document.getElementById('qDate').innerText = new Date().toLocaleDateString('th-TH');
            document.getElementById('qType').innerText = calcMode === 'EXT' ? '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' : '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô';
            
            const tbody = document.getElementById('qBody');
            const detailContent = document.getElementById('qDetailContent');
            tbody.innerHTML = '';
            detailContent.innerHTML = '';
            let sum = 0;
            
            calcItems.forEach((item, idx) => {
                sum += item.grandTotal;
                tbody.innerHTML += `<tr><td class="py-2"><span class="font-bold">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${idx+1}</span> <span class="text-xs text-slate-500 ml-2">(${item.w}x${item.h} ${item.unit})</span></td><td class="py-2 text-center">${item.qty}</td><td class="py-2 text-right">${item.totalPerSet.toLocaleString()}</td><td class="py-2 text-right font-bold">${item.grandTotal.toLocaleString()}</td></tr>`;
                detailContent.innerHTML += `<div class="border-b border-slate-200 pb-2 last:border-0"><span class="font-bold text-sunny-red">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${idx+1}:</span><br>${item.details}</div>`;
            });
            document.getElementById('qGrandTotal').innerText = sum.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
        }
        
        function closeQuotation() { document.getElementById('quotationModal').classList.add('hidden'); }
        function toggleQDetails() { document.getElementById('qDetails').classList.toggle('hidden'); }
        function captureQuotation() { html2canvas(document.querySelector("#quotationModal > div"), { scale: 2, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = `Sunny_Quote_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); }); }
        
        function saveCurrentQuotation() {
            // Check Database Connection for Members
            const user = currentUser;
            const isMember = user && !user.isAnonymous;
            
            if (isMember && (!db || !auth)) {
                alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...');
                return;
            }

            try {
                // Safeguard calcItems
                if (!calcItems || !Array.isArray(calcItems) || calcItems.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà');
                    return;
                }

                // Determine Mode (New or Update)
                let isUpdate = false;
                let saveAsNew = false;

                if (currentEditingId || currentEditingDocId) {
                    // Editing Mode
                    if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°\n‡∏Å‡∏î [‡∏ï‡∏Å‡∏•‡∏á] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (Update)\n‡∏Å‡∏î [‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (Save as New)")) {
                        isUpdate = true;
                    } else {
                        saveAsNew = true;
                    }
                } else {
                    // New Mode
                    const msg = isMember ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)?' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)?';
                    if (!confirm(msg)) return;
                    saveAsNew = true;
                }

                // Prepare Data
                const finalId = (isUpdate && currentEditingId) ? currentEditingId : Date.now();
                const qData = { 
                    id: finalId,
                    date: new Date().toISOString(), 
                    type: calcMode === 'EXT' ? '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' : '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô', 
                    total: document.getElementById('qGrandTotal').innerText, 
                    items: JSON.parse(JSON.stringify(calcItems)) // Deep copy to prevent reference issues
                };
                
                if (isMember) {
                    // Cloud Save
                    qData.uid = user.uid;
                    qData.ownerEmail = user.email;
                    qData.ownerName = user.displayName;
                    
                    if (isUpdate && currentEditingDocId) {
                        db.collection("quotations").doc(currentEditingDocId).update(qData).then(() => { 
                            showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                            closeQuotation();
                            clearCalc(); // Clear to prevent double save confusion
                        }).catch(e => { console.error(e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: " + e.message); });
                    } else {
                        // Save as new (remove docId if it existed from edit mode)
                        delete qData.docId; 
                        db.collection("quotations").add(qData).then(() => { 
                            showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                            closeQuotation();
                            clearCalc();
                        }).catch(e => { console.error(e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + e.message); });
                    }
                } else {
                    // Local Storage Save
                    let saved = [];
                    try {
                        saved = JSON.parse(localStorage.getItem('sunny_quotations')) || [];
                    } catch(e) { saved = []; }

                    if (isUpdate && currentEditingId) {
                        const idx = saved.findIndex(x => x.id === currentEditingId);
                        if (idx !== -1) {
                            saved[idx] = qData;
                            showToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Guest) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                        } else {
                            // ID not found (maybe deleted), save as new
                            saved.push(qData);
                            showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà (Guest) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                        }
                    } else {
                        saved.push(qData);
                        showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Guest) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    }
                    localStorage.setItem('sunny_quotations', JSON.stringify(saved));
                    closeQuotation();
                    clearCalc();
                }
            } catch (e) {
                console.error("Critical Save Error:", e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á: " + e.message);
            }
        }
        
        async function deleteOnlineQuote(docId, containerId, mode) { 
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')) return; 
            try { 
                await db.collection("quotations").doc(docId).delete(); 
                showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); 
                renderQuotationsList(containerId, mode); 
            } catch(e) { console.error(e); alert("Error: " + e.message); } 
        }
        
        function deleteOfflineQuote(id) { 
            if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; 
            let saved = JSON.parse(localStorage.getItem('sunny_quotations')) || []; 
            saved = saved.filter(x => x.id !== id); 
            localStorage.setItem('sunny_quotations', JSON.stringify(saved)); 
            // Re-render user history only since offline is only for user
            renderQuotationsList('user-history-list', 'mine'); 
        }

        // --- NEW: GENERIC RENDER QUOTATIONS ---
        async function renderQuotationsList(containerId, mode = 'mine') {
            const list = document.getElementById(containerId);
            if(!list) return;
            list.innerHTML = '<div class="text-center py-8"><span class="loader inline-block w-6 h-6 border-2 border-slate-200 border-t-sunny-red rounded-full"></span></div>';

            let quotes = [];
            const user = currentUser;

            try {
                if (mode === 'all') {
                    // Admin Mode: Fetch All
                    const snap = await db.collection("quotations").get();
                    snap.forEach(doc => quotes.push({ ...doc.data(), docId: doc.id }));
                } else {
                    // User Mode
                    if (user && !user.isAnonymous) {
                         // Fetch specific user data
                         const snap = await db.collection("quotations").where("uid", "==", user.uid).get();
                         snap.forEach(doc => quotes.push({ ...doc.data(), docId: doc.id }));
                    } else {
                         // Guest: LocalStorage
                         quotes = JSON.parse(localStorage.getItem('sunny_quotations')) || [];
                    }
                }
            } catch(e) {
                console.error(e);
                list.innerHTML = `<div class="text-center text-red-400">Error: ${e.message}</div>`;
                return;
            }

            // Sort Descending (Newest first)
            quotes.sort((a,b) => (b.id || 0) - (a.id || 0));
            tempQuotes = quotes; // Store for access

            if (quotes.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 py-8 flex flex-col items-center"><span class="text-4xl mb-2 opacity-30">üì≠</span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>`;
                return;
            }

            list.innerHTML = '';
            quotes.forEach((q, index) => {
                const dateStr = new Date(q.date || q.id).toLocaleString('th-TH');
                const ownerInfo = (mode === 'all' && q.ownerName) ? `<div class="text-[10px] text-sunny-red bg-red-50 px-1 rounded inline-block mb-1">üë§ ${q.ownerName}</div>` : '';
                
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex justify-between items-center group mb-2";
                div.innerHTML = `
                    <div>
                        ${ownerInfo}
                        <div class="font-bold text-slate-700 text-sm">${q.type} ${!q.uid ? '<span class="text-[9px] bg-gray-100 text-gray-500 px-1 rounded">Local</span>' : ''}</div>
                        <div class="text-xs text-slate-400 mt-0.5">üìÖ ${dateStr} <span class="text-slate-300">|</span> ${q.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-lg text-sunny-red">${q.total}</div>
                        <div class="flex gap-2 justify-end mt-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick='loadQuoteByIndex(${index})' class="px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs rounded-lg font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏î‡∏π</button>
                            <button onclick="${(mode === 'all' || (user && !user.isAnonymous)) ? `deleteOnlineQuote('${q.docId}', '${containerId}', '${mode}')` : `deleteOfflineQuote(${q.id})`}" class="px-3 py-1 bg-red-50 hover:bg-red-100 text-red-500 text-xs rounded-lg font-bold">‡∏•‡∏ö</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        function loadQuoteByIndex(index) {
            const q = tempQuotes[index];
            if(!q) return;
            
            // Restore Data & Track IDs for editing
            calcMode = (q.type && q.type.includes('‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å')) ? 'EXT' : 'INT';
            calcItems = q.items || []; // Safety check for items
            currentEditingId = q.id;
            currentEditingDocId = q.docId || null;
            
            // Close Modals
            document.getElementById('historyModal').classList.add('hidden');
            closeConfig();
            
            // Switch UI to Calculator (Edit Mode)
            openCalculator(calcMode);
            
            // Show Quotation View (Preview)
            showQuotationModal();
            
            showToast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
        
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            renderQuotationsList('user-history-list', 'mine');
        }

        // --- ADMIN FUNCTIONS ---
        function renderAdminMenu() {
            const list = document.getElementById('admin-menu-list');
            list.innerHTML = '';
            tempConfig.menus.forEach((menu, idx) => {
                list.innerHTML += `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 flex flex-col gap-3">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-slate-100 rounded text-slate-500">${ICONS[menu.icon]||'?'}</div>
                            <div class="flex-grow space-y-1">
                                <input type="text" value="${menu.name}" onchange="tempConfig.menus[${idx}].name=this.value" class="w-full p-1 border rounded text-sm font-bold">
                                <input type="text" value="${menu.sub}" onchange="tempConfig.menus[${idx}].sub=this.value" class="w-full p-1 border rounded text-xs text-slate-500">
                            </div>
                            <input type="checkbox" ${menu.active?'checked':''} onchange="tempConfig.menus[${idx}].active=this.checked" class="w-5 h-5 accent-sunny-red">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 mb-1 block">URL ‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏£‡∏π‡∏õ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , )</label>
                            <textarea rows="2" onchange="tempConfig.menus[${idx}].bgImage=this.value" class="w-full p-2 border rounded text-xs text-slate-600 bg-slate-50 focus:ring-1 focus:ring-sunny-red focus:outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://img1.com, https://img2.com...">${menu.bgImage || ''}</textarea>
                        </div>
                    </div>`;
            });
        }

        function renderAdminNews() {
            const list = document.getElementById('admin-news-list'); 
            list.innerHTML = '';
            const sorted = [...tempConfig.newsItems].sort((a,b) => (b.pinned===a.pinned)? 0 : b.pinned? 1 : -1);
            
            sorted.forEach((item, idx) => {
                const realIdx = tempConfig.newsItems.findIndex(x => x.id === item.id);
                
                let emojiGridText = EMOJI_LIST.map(e => `<button onclick="insertEmoji(${realIdx}, '${e}', 'text')" class="text-xl hover:bg-slate-100 p-2 rounded transition-colors">${e}</button>`).join('');
                let emojiGridBadge = EMOJI_LIST.map(e => `<button onclick="insertEmoji(${realIdx}, '${e}', 'badge')" class="text-xl hover:bg-slate-100 p-2 rounded transition-colors">${e}</button>`).join('');

                const createToolbar = (type) => `
                    <div class="flex gap-1 mb-1.5 flex-wrap items-center">
                        <button onmousedown="event.preventDefault()" onclick="execCmd('bold')" class="px-2 py-1 bg-white border border-slate-200 rounded text-[10px] font-bold hover:bg-slate-50 hover:text-sunny-red min-w-[24px]">B</button>
                        <button onmousedown="event.preventDefault()" onclick="execCmd('italic')" class="px-2 py-1 bg-white border border-slate-200 rounded text-[10px] italic hover:bg-slate-50 hover:text-sunny-red min-w-[24px]">I</button>
                        <button onmousedown="event.preventDefault()" onclick="execCmd('underline')" class="px-2 py-1 bg-white border border-slate-200 rounded text-[10px] underline hover:bg-slate-50 hover:text-sunny-red min-w-[24px]">U</button>
                        <div class="w-px h-6 bg-slate-200 mx-1"></div>
                        <button onmousedown="event.preventDefault()" onclick="document.getElementById('emoji-picker-${type === 'badge' ? 'badge-' : ''}${realIdx}').classList.toggle('hidden')" class="px-2 py-1 bg-white border border-slate-200 rounded text-[10px] hover:bg-slate-50 hover:text-sunny-red">üòÄ</button>
                    </div>
                `;

                list.innerHTML += `
                    <div class="p-4 rounded-xl border ${item.pinned ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200'} relative group shadow-sm mb-4">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 space-y-2">
                                    <div class="flex justify-between items-end"><label class="text-[10px] text-slate-400 font-bold uppercase">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label></div>
                                    ${createToolbar('text')}
                                    <div class="relative">
                                        <div id="news-edit-${realIdx}" contenteditable="true" class="w-full p-2 text-sm border rounded bg-white focus:outline-none focus:ring-1 focus:ring-sunny-red min-h-[60px] max-h-32 overflow-y-auto font-sans" oninput="tempConfig.newsItems[${realIdx}].text = this.innerHTML">${item.text}</div>
                                        <div id="emoji-picker-${realIdx}" class="hidden absolute top-8 left-0 z-50 bg-white border border-slate-200 shadow-xl rounded-xl p-2 w-64 mt-1">
                                            <div class="flex justify-between items-center px-2 pb-2 border-b border-slate-100 mb-2"><span class="text-xs font-bold text-slate-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Emoji</span><button onclick="document.getElementById('emoji-picker-${realIdx}').classList.add('hidden')" class="text-slate-300 hover:text-red-500 text-xs">‚úï</button></div>
                                            <div class="grid grid-cols-5 gap-1 max-h-48 overflow-y-auto custom-scrollbar">${emojiGridText}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2 pt-8">
                                    <button onclick="togglePinNews(${realIdx})" class="${item.pinned?'text-white bg-sunny-red':'text-slate-400 bg-white border'} p-2 rounded-lg shadow-sm transition-all hover:scale-105" title="${item.pinned?'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î':'‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î'}"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg></button>
                                    <button onclick="deleteNews(${realIdx})" class="text-slate-400 hover:text-red-500 bg-white border p-2 rounded-lg shadow-sm transition-all hover:scale-105" title="‡∏•‡∏ö"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 border-t border-slate-200 pt-3 mt-1">
                                <div class="relative">
                                    <label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡πâ‡∏≤‡∏¢ (Badge)</label>
                                    <div class="flex items-center gap-1 mb-1">
                                        <button onmousedown="event.preventDefault()" onclick="document.getElementById('emoji-picker-badge-${realIdx}').classList.toggle('hidden')" class="p-1 bg-white border border-slate-200 rounded text-[10px] hover:bg-slate-50">üòÄ</button>
                                    </div>
                                    <div id="badge-edit-${realIdx}" contenteditable="true" class="w-full p-1.5 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-sunny-red font-bold text-slate-600 bg-white min-h-[30px] whitespace-nowrap overflow-hidden" oninput="tempConfig.newsItems[${realIdx}].badgeLabel = this.innerHTML">${item.badgeLabel}</div>
                                    <div id="emoji-picker-badge-${realIdx}" class="hidden absolute bottom-full left-0 mb-1 z-50 bg-white border border-slate-200 shadow-xl rounded-xl p-2 w-64">
                                        <div class="flex justify-between items-center px-2 pb-2 border-b border-slate-100 mb-2"><span class="text-xs font-bold text-slate-400">Emoji (‡∏õ‡πâ‡∏≤‡∏¢)</span><button onclick="document.getElementById('emoji-picker-badge-${realIdx}').classList.add('hidden')" class="text-slate-300 hover:text-red-500 text-xs">‚úï</button></div>
                                        <div class="grid grid-cols-5 gap-1 max-h-48 overflow-y-auto custom-scrollbar">${emojiGridBadge}</div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≤‡∏¢</label>
                                    <div class="flex items-center gap-2">
                                        <input type="color" value="${item.badgeColor}" onchange="tempConfig.newsItems[${realIdx}].badgeColor=this.value" class="h-8 w-10 border rounded cursor-pointer p-0 overflow-hidden">
                                        <span class="text-[10px] text-slate-400 font-mono">${item.badgeColor}</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏õ‡πâ‡∏≤‡∏¢</label>
                                    <div class="flex items-center gap-2">
                                        <input type="color" value="${item.badgeTextColor}" onchange="tempConfig.newsItems[${realIdx}].badgeTextColor=this.value" class="h-8 w-10 border rounded cursor-pointer p-0 overflow-hidden">
                                        <span class="text-[10px] text-slate-400 font-mono">${item.badgeTextColor}</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å</label>
                                    <div class="flex items-center gap-2">
                                        <input type="color" value="${item.textColor}" onchange="tempConfig.newsItems[${realIdx}].textColor=this.value" class="h-8 w-10 border rounded cursor-pointer p-0 overflow-hidden">
                                        <span class="text-[10px] text-slate-400 font-mono">${item.textColor}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end pt-2 border-t border-slate-100 border-dashed">
                                <div class="flex items-center gap-2">
                                    <label class="text-[10px] text-slate-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                                    <input type="date" value="${item.date.split('T')[0]}" onchange="tempConfig.newsItems[${realIdx}].date=this.value" class="text-xs border rounded p-1 text-slate-500 bg-slate-50">
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }
        
        function togglePinNews(idx) {
            tempConfig.newsItems[idx].pinned = !tempConfig.newsItems[idx].pinned;
            renderAdminNews();
        }

        function addNewNewsItem() { 
            tempConfig.newsItems.unshift({ 
                id: Date.now(), 
                text: "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà...", 
                date: new Date().toISOString(), 
                pinned: false, 
                badgeLabel: "NEW!", 
                badgeColor: "#E63946", 
                badgeTextColor: "#FFFFFF", 
                textColor: "#334155" 
            }); 
            renderAdminNews(); 
        }

        function deleteNews(idx) { 
            if(confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ?')) {
                tempConfig.newsItems.splice(idx, 1); 
                renderAdminNews(); 
            }
        }

        function saveConfig() {
            tempConfig.appTitle = document.getElementById('conf-app-title').value;
            tempConfig.newsSettings.speed = parseInt(document.getElementById('conf-news-speed').value);
            appConfig = tempConfig;
            applyTheme(appConfig.theme);
            
            // Allow anyone with DB access to write config (Rules permitting)
            // Or assume Admin is logged in via 'isAdminLoggedIn' check or similar context.
            // Since we use global 'db', it works if Auth is successful (Guest or Member).
            
            db.collection("app_settings").doc("config").set(appConfig).then(()=>{showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");closeConfig();renderSidebar();});
        }
        
        function renderAdminFeatures() {
            const list = document.getElementById('admin-features-list');
            list.innerHTML = '';
            Object.keys(tempConfig.features).forEach(key => {
                list.innerHTML += `<div class="flex justify-between items-center p-3 bg-white border rounded-xl"><span class="font-mono text-sm">${key}</span><input type="checkbox" ${tempConfig.features[key]?'checked':''} onchange="tempConfig.features['${key}']=this.checked" class="w-5 h-5 accent-purple-600"></div>`;
            });
        }
        
        function addNewFeature() {
            const key = document.getElementById('new-feature-key').value.trim();
            if(key) {
                tempConfig.features[key] = false;
                renderAdminFeatures();
                document.getElementById('new-feature-key').value='';
            }
        }
        
        function renderSidebar() {
            const container = document.getElementById('sidebar-menu-container');
            if (!container) return;
            container.innerHTML = `<div class="px-6 mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>`;
            appConfig.menus.forEach(menu => {
                if (!menu.active) return;
                const activeClass = currentSystem === menu.id ? 'active' : '';
                const iconSvg = ICONS[menu.icon] || ICONS['wood'];
                container.innerHTML += `
                    <a href="#" onclick="switchSystem('${menu.id}')" class="menu-item ${activeClass} group flex items-center px-6 py-3 text-slate-600 hover:bg-red-50 hover:text-sunny-red transition-all duration-300 ease-out border-l-4 border-transparent hover:border-sunny-red">
                        <div class="w-8 flex justify-center mr-2 transition-transform group-hover:scale-110 duration-300">${iconSvg}</div>
                        <div class="flex flex-col"><span class="font-medium transition-transform group-hover:translate-x-1 duration-300">${menu.name}</span>${menu.sub?`<span class="text-[10px] text-slate-400 group-hover:text-red-300 transition-colors">${menu.sub}</span>`:''}</div>
                    </a>`;
            });
            const isAdmin = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (appConfig.calcSettings.enabled || isAdmin) {
                container.innerHTML += `<div class="px-6 mt-6 mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider flex justify-between"><span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</span>${!appConfig.calcSettings.enabled ? '<span class="text-[9px] bg-red-100 text-red-500 px-1 rounded">Admin View</span>' : ''}</div><a href="#" onclick="switchCalcMode('EXT')" class="group flex items-center px-6 py-3 text-slate-600 hover:bg-red-50 hover:text-sunny-red transition-all duration-300 ease-out border-l-4 border-transparent hover:border-sunny-red"><div class="w-8 flex justify-center mr-2 text-xl transition-transform group-hover:scale-110 duration-300">ü™ü</div><span class="font-medium transition-transform group-hover:translate-x-1 duration-300">‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</span></a><a href="#" onclick="switchCalcMode('INT')" class="group flex items-center px-6 py-3 text-slate-600 hover:bg-red-50 hover:text-sunny-red transition-all duration-300 ease-out border-l-4 border-transparent hover:border-sunny-red"><div class="w-8 flex justify-center mr-2 text-xl transition-transform group-hover:scale-110 duration-300">üè†</div><span class="font-medium transition-transform group-hover:translate-x-1 duration-300">‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô</span></a>`;
            }
            const titleEl = document.getElementById('app-title-display');
            if(titleEl) titleEl.innerText = appConfig.appTitle;
            
            // Re-render user sidebar to ensure state is kept
            renderUserSidebar(currentUser);
            checkPwaStatus();
        }
        
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebarOverlay'); sb.classList.toggle('-translate-x-full'); ov.classList.toggle('hidden'); }
        function toggleHelpModal(show) { document.getElementById('helpModal').classList.toggle('hidden', !show); }
        function toggleCodeListModal(show) { document.getElementById('codeListModal').classList.toggle('hidden', !show); }
        function checkAdminLogin() { if (localStorage.getItem('isAdminLoggedIn') === 'true') openConfig(); else openAdminLogin(); }
        function openAdminLogin() { document.getElementById('adminLoginModal').classList.remove('hidden'); document.getElementById('adminPassword').value=''; document.getElementById('loginError').classList.add('hidden'); document.getElementById('adminPassword').focus(); }
        function closeAdminLogin() { document.getElementById('adminLoginModal').classList.add('hidden'); }
        function handleLogin() { if(document.getElementById('adminPassword').value === 'sn1988') { localStorage.setItem('isAdminLoggedIn', 'true'); closeAdminLogin(); showToast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); openConfig(); renderSidebar(); } else { document.getElementById('loginError').classList.remove('hidden'); } }
        function logoutAdmin() { localStorage.removeItem('isAdminLoggedIn'); closeConfig(); showToast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); renderSidebar(); }
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            const tm = document.getElementById('toast-message');
            if(t && tm) {
                tm.innerText = msg; 
                t.classList.remove('opacity-0','pointer-events-none','toast-hide'); 
                t.classList.add('toast-show'); 
                setTimeout(()=>{t.classList.remove('toast-show');t.classList.add('toast-hide');},2500); 
            }
        }

        function openConfig() {
            tempConfig = JSON.parse(JSON.stringify(appConfig));
            document.getElementById('adminConfigModal').classList.remove('hidden');
            document.getElementById('conf-app-title').value = tempConfig.appTitle;
            document.getElementById('conf-news-speed').value = tempConfig.newsSettings.speed || 3;
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('conf-calc-enabled').checked = tempConfig.calcSettings.enabled;
            document.getElementById('factor-fabricMult').value = tempConfig.calcSettings.factors.fabricMult;
            document.getElementById('factor-minArea').value = tempConfig.calcSettings.factors.minArea;
            document.getElementById('factor-eqExt').value = tempConfig.calcSettings.factors.eqExt;
            document.getElementById('factor-railTop').value = tempConfig.calcSettings.factors.railTop;
            document.getElementById('factor-railBot').value = tempConfig.calcSettings.factors.railBot;
            document.getElementById('factor-sling').value = tempConfig.calcSettings.factors.sling;
            const theme = tempConfig.theme || 'default';
            const radios = document.getElementsByName('app-theme');
            for(const r of radios) { r.checked = (r.value === theme); }
            
            // Check status based on auth
            const st = document.getElementById('admin-mode-status');
            const isConnected = auth && auth.currentUser;
            st.innerText = isConnected ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Online Mode" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Offline Mode";
            st.className = isConnected ? "text-xs font-bold text-green-600" : "text-xs font-bold text-red-600";
            switchAdminTab('menu');
        }
        
        function closeConfig() { applyTheme(appConfig.theme); document.getElementById('adminConfigModal').classList.add('hidden'); }
        
        function switchAdminTab(tab) {
            ['menu','news','calc','saved', 'theme', 'features'].forEach(t => {
                const btn = document.getElementById('tab-btn-'+t);
                const content = document.getElementById('tab-content-'+t);
                if(btn) btn.className = "px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap flex items-center gap-1";
                if(content) content.classList.add('hidden');
            });
            const activeBtn = document.getElementById('tab-btn-'+tab);
            const activeContent = document.getElementById('tab-content-'+tab);
            if(activeBtn) activeBtn.className = "px-4 py-3 text-sm font-bold border-b-2 border-sunny-red text-sunny-red bg-red-50 whitespace-nowrap flex items-center gap-1";
            if(activeContent) activeContent.classList.remove('hidden');
            if(tab === 'menu') renderAdminMenu();
            if(tab === 'news') renderAdminNews();
            // --- UPDATE: Use new generic function, 'all' mode ---
            if(tab === 'saved') renderQuotationsList('saved-quotations-list', 'all'); 
            if(tab === 'features') renderAdminFeatures();
        }
        
        function previewTheme(themeName) { applyTheme(themeName); tempConfig.theme = themeName; }

        // --- PWA INSTALL LOGIC (PWA) ---
        window.addEventListener('beforeinstallprompt', (e) => { 
            e.preventDefault(); 
            deferredPrompt = e; 
            checkPwaStatus(); 
        });
        
        function isStandalone() { return (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone) || document.referrer.includes('android-app://'); }
        
        function checkPwaStatus() { 
            const sidebarBtn = document.getElementById('pwaInstallBtn'); 
            const headerBtn = document.getElementById('headerInstallBtn'); 
            
            if(isStandalone()) { 
                if(sidebarBtn) sidebarBtn.classList.add('hidden'); 
                if(headerBtn) headerBtn.classList.add('hidden'); 
                return; 
            } 
            
            if(headerBtn) headerBtn.classList.remove('hidden'); 
            if (sidebarBtn) { 
                sidebarBtn.classList.remove('hidden'); 
                sidebarBtn.onclick = installApp; 
            } 
        }
        
        async function installApp() { 
            if (deferredPrompt) { 
                deferredPrompt.prompt(); 
                const { outcome } = await deferredPrompt.userChoice; 
                deferredPrompt = null; 
                if(outcome === 'accepted') { 
                    checkPwaStatus(); 
                } 
                return; 
            } 
            document.getElementById('installGuideModal').classList.remove('hidden'); 
        }
        
        window.addEventListener('appinstalled', () => { 
            console.log('App installed'); 
            checkPwaStatus(); 
        });

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => { 
            // 1. Init Firebase (Async & Auth Listener)
            initFirebase();
            
            // 2. Render Initial UI (Sync)
            renderSidebar();
            
            // 3. Setup Logic
            setupAutocomplete();
            if(typeof checkPwaStatus === 'function') checkPwaStatus();

            // 4. Switch System after a brief delay to ensure DOM is fully ready
            setTimeout(() => {
                switchSystem('WOOD');
                renderNews();
                const s = document.getElementById('intro-splash');
                if(s) {
                    s.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => s.remove(), 700);
                }
            }, 500); 
        });

        // --- UTILS (UI) ---
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebarOverlay'); sb.classList.toggle('-translate-x-full'); ov.classList.toggle('hidden'); }
        function toggleHelpModal(show) { document.getElementById('helpModal').classList.toggle('hidden', !show); }
        function toggleCodeListModal(show) { document.getElementById('codeListModal').classList.toggle('hidden', !show); }
    </script>
</body>
</html>
