<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E63946">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SUNNY Stock">

    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiU1VOTlkgU3RvY2sgU3lzdGVtIiwic2hvcnRfbmFtZSI6IlNVTk5ZIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiNFNjM5NDYiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnS1wbmcuZmxhdGljb24uY29tLzUxMi8xMDYzLzEwNjMzNzYucG5nIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å & ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ - SUNNY</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iI0U2Mzk0NiIgcng9IjgwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjkwMCIgZm9udC1zdHlsZT0iaXRhbGljIiBmb250LXNpemU9IjM1MCI+UzwvdGV4dD48L3N2Zz4=">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Security Shield
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) return false;
            if (e.ctrlKey && e.keyCode == 85) return false;
            if (e.ctrlKey && e.keyCode == 83) return false;
        };

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'Inter', 'sans-serif'] },
                    colors: { 'sunny-red': '#E63946', 'sunny-dark': '#1D3557', 'sunny-bg': '#F1FAEE' }
                }
            }
        }
    </script>
    <style>
        .loader { border-top-color: #E63946; animation: spin 1s infinite linear; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .wooden-pattern { background-image: repeating-linear-gradient(180deg, rgba(210, 180, 140, 0.05) 0px, rgba(210, 180, 140, 0.05) 15px, rgba(0, 0, 0, 0.02) 16px, transparent 16px, transparent 24px); }
        .bento-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .noselect { -webkit-user-select: none; user-select: none; }
        .ticker-wrap { width: 100%; height: 7rem; overflow: hidden; position: relative; }
        .ticker-move { display: inline-block; width: 100%; position: absolute; top: 0; left: 0; }
        @keyframes verticalSlide { 0% { transform: translateY(0); } 100% { transform: translateY(-50%); } }
        @keyframes slideDown { 0% { transform: translate(-50%, -100%); opacity: 0; } 100% { transform: translate(-50%, 20px); opacity: 1; } }
        @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
        .toast-show { animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .toast-hide { animation: fadeOut 0.5s forwards; }

        @media print {
            body * { visibility: hidden; }
            #quotationModal, #quotationModal * { visibility: visible; }
            #quotationModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; z-index: 9999; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 h-[100dvh] font-sans text-slate-800 flex overflow-hidden noselect">

    <!-- Components -->
    <div id="intro-splash" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-700 ease-out">
        <h1 class="text-6xl font-black text-sunny-red italic tracking-tighter">SUNNY</h1>
        <p class="text-sm font-bold text-slate-400 mt-4 tracking-widest">STOCK SYSTEM</p>
    </div>

    <div id="toast" class="fixed top-0 left-1/2 -translate-x-1/2 z-[200] opacity-0 pointer-events-none bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        <span id="toast-message" class="text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
    </div>

    <div id="emojiPicker" class="hidden fixed bg-white border border-slate-200 shadow-2xl rounded-2xl p-3 z-[9999] grid grid-cols-6 gap-2 w-72 max-h-60 overflow-y-auto"></div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-xs text-center animate-fade-in-up">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <p class="text-slate-500 text-sm mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-2">
                <button onclick="closeConfirmModal()" class="flex-1 py-2.5 text-slate-500 bg-slate-100 rounded-xl hover:bg-slate-200 font-bold text-sm transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirmDeleteBtn" class="flex-1 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 font-bold text-sm shadow-lg shadow-red-200 transition-colors">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <button onclick="toggleSidebar()" class="md:hidden fixed top-3 left-3 z-50 bg-white/90 backdrop-blur p-2.5 rounded-xl shadow-lg border border-slate-100 text-slate-600 active:scale-95 transition-transform flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        <span class="text-xs font-bold text-slate-700">‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    </button>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-white shadow-2xl transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out border-r border-slate-100 flex flex-col h-full">
        <div class="p-6 border-b border-slate-100 flex items-center gap-3 pt-12 md:pt-6">
             <div class="w-10 h-10 bg-sunny-red rounded-lg flex items-center justify-center text-white font-black italic text-xl shadow-red-200 shadow-lg shrink-0">S</div>
             <div><h1 class="font-black text-xl text-sunny-red italic tracking-tighter" id="app-title-display">SUNNY</h1><p class="text-[10px] text-slate-400 uppercase tracking-widest">Stock & Calc</p></div>
             <button onclick="toggleSidebar()" class="md:hidden ml-auto text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="sidebar-menu-container"></nav>
        <div class="p-6 border-t border-slate-100 space-y-3">
            <button id="pwaInstallBtn" class="hidden w-full flex items-center justify-center gap-2 bg-slate-800 text-white py-3 rounded-xl text-sm font-bold hover:bg-black transition-colors mb-2">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û</button>
            <button onclick="requestNotificationPermission()" class="w-full flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-3 rounded-xl text-sm font-bold hover:bg-blue-100 transition-colors mb-2">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
            <button onclick="toggleHelpModal(true)" class="w-full flex items-center justify-center gap-2 bg-slate-100 text-slate-600 py-3 rounded-xl text-sm font-bold hover:bg-slate-200 transition-colors">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <button onclick="checkAdminLogin()" class="w-full flex items-center justify-center gap-2 text-slate-300 hover:text-sunny-red py-2 rounded-xl text-xs transition-colors">Admin Mode</button>
        </div>
    </aside>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <main class="flex-1 md:ml-72 h-full overflow-y-auto overflow-x-hidden scrolling-touch relative">
        <div class="p-4 pt-16 md:p-8 pb-40 max-w-6xl mx-auto space-y-6">
            <div id="headerSection" class="bg-white rounded-[2rem] p-6 md:p-8 shadow-sm border border-slate-100 wooden-pattern relative overflow-hidden">
                <div class="relative z-10">
                    <h2 id="systemTitle" class="text-xs md:text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
                    <h1 class="text-3xl md:text-5xl font-black text-slate-800 tracking-tight leading-tight">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<span class="text-sunny-red italic block md:inline" id="productTypeLabel">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></h1>
                    <div class="mt-3 flex flex-wrap items-center gap-3">
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-50 text-green-700 text-xs font-bold border border-green-100"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>Online</span>
                        <span class="text-slate-400 text-xs">Updated: <span id="lastUpdateDisplay" class="font-semibold text-slate-600">...</span></span>
                    </div>
                </div>
            </div>

            <div id="news-container" class="space-y-3 hidden">
                <div id="pinned-news-wrapper" class="space-y-2"></div>
                <div id="scrolling-news-wrapper" class="hidden bg-white/80 backdrop-blur rounded-xl border border-slate-200 p-2 shadow-sm flex items-start gap-3 h-28 relative z-10 overflow-hidden">
                    <div class="shrink-0 flex items-center gap-2 pr-3 border-r border-slate-100 h-full relative z-20 bg-white/80">
                        <div class="bg-blue-50 text-blue-600 p-1.5 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" /></svg></div>
                        <span class="text-xs font-bold text-slate-400 uppercase hidden md:block self-center">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
                    </div>
                    <div class="ticker-wrap flex-1"><div id="news-ticker-track" class="ticker-move flex flex-col"></div></div>
                </div>
            </div>

            <div id="mainContentArea">
                <div id="searchSection" class="space-y-6">
                    <div class="sticky top-2 z-20">
                        <div class="bg-white/90 backdrop-blur-xl rounded-2xl p-2 shadow-xl shadow-slate-200/50 border border-white/50 flex items-center gap-2 transition-all">
                            <button onclick="toggleCodeListModal(true)" class="p-2 md:px-3 text-slate-400 hover:text-sunny-red hover:bg-red-50 rounded-xl transition-colors flex items-center gap-1"><span class="hidden md:inline text-sm font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</span></button>
                            <input type="text" id="productCodeInput" class="flex-grow bg-transparent border-none outline-none text-lg font-medium text-slate-800 placeholder-slate-400 h-12 md:h-14 w-full min-w-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™..." onkeypress="if(event.key === 'Enter') searchProduct()" inputmode="search" autocomplete="off" list="codeSuggestions"><datalist id="codeSuggestions"></datalist>
                            <button id="searchButton" onclick="searchProduct()" class="bg-sunny-red hover:bg-red-700 text-white px-5 md:px-8 py-2.5 md:py-3 rounded-xl font-bold text-base md:text-lg shadow-lg shadow-red-200 transition-all active:scale-95 whitespace-nowrap shrink-0">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        </div>
                    </div>
                    <div id="resultContainer" class="min-h-[300px]">
                        <div id="initialMessage" class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200"><p class="font-medium text-slate-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p></div>
                        <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center h-64 bg-white rounded-3xl shadow-sm"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div><p class="text-slate-500 font-medium animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
                        <div id="productCard" class="hidden animate-fade-in-up space-y-4"><div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4"><div class="flex-1"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><h2 id="productCodeDisplay" class="text-3xl md:text-4xl font-black text-slate-800 break-words"></h2></div><div class="flex-[2] pt-4 md:pt-0 border-t md:border-t-0 md:border-l border-slate-100 md:pl-6"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><h3 id="productName" class="text-xl md:text-2xl font-bold text-slate-700 leading-snug"></h3></div></div><div id="stockGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 pb-4"></div></div>
                        <div id="errorMessage" class="hidden h-64 bg-red-50 border border-red-100 rounded-3xl flex flex-col items-center justify-center text-red-600 p-6 text-center"><h3 class="text-lg font-bold mb-1">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><p id="errorText" class="text-sm text-red-500"></p></div>
                    </div>
                </div>

                <div id="calculatorSection" class="hidden space-y-6 animate-fade-in-up">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span id="calcTitleIcon">ü™ü</span> <span id="calcTitleText">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</span></h3>
                            <div class="flex bg-slate-100 p-1 rounded-xl"><button onclick="setCalcUnit('m')" id="btnUnitM" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-sunny-red">‡πÄ‡∏°‡∏ï‡∏£</button><button onclick="setCalcUnit('cm')" id="btnUnitCM" class="px-4 py-1.5 rounded-lg text-xs font-bold text-slate-500 transition-all">‡∏ã‡∏°.</button></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                            <div><label class="text-[10px] text-slate-400 font-bold">‡∏Å‡∏ß‡πâ‡∏≤‡∏á</label><input type="number" id="calcW" class="w-full p-2 border rounded-lg bg-slate-50 text-sm font-bold" placeholder="0.00"></div>
                            <div><label class="text-[10px] text-slate-400 font-bold">‡∏™‡∏π‡∏á</label><input type="number" id="calcH" class="w-full p-2 border rounded-lg bg-slate-50 text-sm font-bold" placeholder="0.00"></div>
                            <div><label class="text-[10px] text-slate-400 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤</label><input type="number" id="calcPrice" class="w-full p-2 border rounded-lg bg-slate-50 text-sm font-bold" placeholder="259"></div>
                            <div><label class="text-[10px] text-slate-400 font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" id="calcQty" class="w-full p-2 border rounded-lg bg-slate-50 text-sm font-bold" value="1"></div>
                            <div class="col-span-2 md:col-span-1 flex items-end"><button onclick="addCalcItem()" class="w-full bg-slate-800 text-white p-2 rounded-lg font-bold hover:bg-black text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-400 uppercase bg-slate-50"><tr><th class="px-3 py-2 rounded-l-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="px-3 py-2">‡∏Ç‡∏ô‡∏≤‡∏î</th><th class="px-3 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏∏‡∏î</th><th class="px-3 py-2 text-right">‡∏£‡∏ß‡∏°</th><th class="px-3 py-2 rounded-r-lg"></th></tr></thead><tbody id="calcTableBody"></tbody></table></div>
                        <div class="mt-6 pt-4 border-t border-slate-100 flex justify-between items-end"><div class="text-xs text-slate-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span id="totalItems">0</span> ‡∏ä‡∏∏‡∏î</div><div class="text-right"><span class="text-xs text-slate-400 block">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span id="grandTotal" class="text-3xl font-black text-sunny-red">0</span> <span class="text-sm font-bold text-slate-600">‡∏ö‡∏≤‡∏ó</span></div></div>
                        <div class="mt-6 flex gap-3"><button onclick="clearCalc()" class="px-4 py-2 text-slate-400 hover:text-red-500 text-sm font-bold">‡∏•‡πâ‡∏≤‡∏á</button><button onclick="showQuotationModal()" class="flex-1 bg-sunny-red text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 flex justify-center items-center gap-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="quotationModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[300] flex items-center justify-center p-0 md:p-4 overflow-y-auto">
        <div class="bg-white w-full md:max-w-2xl min-h-screen md:min-h-0 md:rounded-2xl shadow-2xl flex flex-col relative">
            <div class="p-4 border-b flex justify-between items-center no-print"><h3 class="font-bold text-lg">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3><button onclick="closeQuotation()" class="text-slate-400 hover:text-red-500">X</button></div>
            <div id="quotationContent" class="p-8 bg-white flex-1 relative">
                <div class="flex justify-between items-start mb-8"><div><h1 class="text-3xl font-black text-sunny-red italic">SUNNY</h1><p class="text-xs font-bold text-slate-400 uppercase">Stock System</p></div><div class="text-right"><h2 class="text-xl font-bold text-slate-800">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2><p class="text-xs text-slate-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="qDate"></span></p><p class="text-xs text-slate-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <span id="qType" class="font-bold"></span></p></div></div>
                <table class="w-full text-sm mb-6"><thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200"><tr><th class="py-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏∏‡∏î</th><th class="py-2 text-right">‡∏£‡∏ß‡∏°</th></tr></thead><tbody id="qBody" class="text-slate-700 divide-y divide-slate-100"></tbody><tfoot class="border-t-2 border-slate-100"><tr><td colspan="3" class="pt-4 text-right font-bold text-slate-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td><td class="pt-4 text-right font-black text-xl text-sunny-red" id="qGrandTotal"></td></tr></tfoot></table>
                <div id="qDetails" class="hidden mt-6 p-4 bg-slate-50 rounded-xl border border-slate-100 text-xs text-slate-600 space-y-2"><h4 class="font-bold text-slate-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</h4><div id="qDetailContent" class="space-y-3 font-mono"></div></div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex gap-2 no-print"><button onclick="toggleQDetails()" class="px-4 py-2 text-slate-600 bg-white border border-slate-200 rounded-xl hover:bg-slate-100 text-xs font-bold">‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</button><div class="flex-1"></div><button onclick="saveCurrentQuotation()" class="px-6 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="captureQuotation()" class="px-6 py-2 bg-slate-800 text-white rounded-xl hover:bg-black font-bold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button></div>
        </div>
    </div>

    <div id="adminLoginModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xs w-full p-6 text-center animate-fade-in-up">
            <h3 class="text-lg font-bold text-slate-800 mb-4">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <input type="password" id="adminPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 mb-4 text-center focus:outline-none focus:ring-2 focus:ring-sunny-red" onkeypress="if(event.key === 'Enter') handleLogin()">
            <p id="loginError" class="text-red-500 text-sm mb-4 hidden animate-pulse">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            <div class="flex gap-2"><button onclick="closeAdminLogin()" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="handleLogin()" class="flex-1 py-2 bg-sunny-red text-white rounded-xl hover:bg-red-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
    </div>

    <div id="adminConfigModal" class="hidden fixed inset-0 bg-white z-[100] flex flex-col animate-fade-in-up">
        <div class="p-4 border-b flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h3><button onclick="closeConfig()" class="text-slate-400 hover:text-red-500">X</button></div>
        <div class="flex border-b border-slate-200 overflow-x-auto"><button onclick="switchAdminTab('menu')" id="tab-btn-menu" class="px-4 py-3 text-sm font-bold border-b-2 border-sunny-red text-sunny-red bg-red-50 whitespace-nowrap">‡πÄ‡∏°‡∏ô‡∏π</button><button onclick="switchAdminTab('news')" id="tab-btn-news" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</button><button onclick="switchAdminTab('calc')" id="tab-btn-calc" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button><button onclick="switchAdminTab('saved')" id="tab-btn-saved" class="px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></div>
        <div class="flex-1 overflow-y-auto p-6 max-w-2xl mx-auto w-full bg-slate-50">
            <div id="tab-content-menu" class="space-y-6"><div class="space-y-2"><label class="block text-sm font-bold text-slate-700">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ</label><input type="text" id="conf-app-title" class="w-full p-3 border rounded-xl bg-white"></div><div class="space-y-4"><h4 class="font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h4><div id="admin-menu-list" class="space-y-4"></div></div></div>
            <div id="tab-content-news" class="hidden space-y-6"><div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-4"><h4 class="font-bold text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h4><div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</label><input type="range" id="conf-news-speed" min="1" max="5" class="w-full accent-sunny-red"></div></div><div class="space-y-4"><div class="flex justify-between items-center"><h4 class="font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h4><button onclick="addNewNewsItem()" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-black">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div><div id="admin-news-list" class="space-y-4 pb-10"></div></div></div>
            <div id="tab-content-calc" class="hidden space-y-6"><div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-slate-800">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h4><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="conf-calc-enabled" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div></div><div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-4"><h4 class="font-bold text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£</h4><div class="grid grid-cols-2 gap-4"><div><label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ú‡πâ‡∏≤</label><input type="number" step="0.1" id="factor-fabricMult" class="w-full p-2 border rounded bg-slate-50"></div><div><label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" step="0.1" id="factor-minArea" class="w-full p-2 border rounded bg-slate-50"></div><div><label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</label><input type="number" id="factor-eqExt" class="w-full p-2 border rounded bg-slate-50"></div><div><label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏£‡∏≤‡∏á‡∏ö‡∏ô</label><input type="number" id="factor-railTop" class="w-full p-2 border rounded bg-slate-50"></div><div><label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏£‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á</label><input type="number" id="factor-railBot" class="w-full p-2 border rounded bg-slate-50"></div><div><label class="block text-[10px] text-slate-500 font-bold mb-1">‡∏™‡∏•‡∏¥‡∏á</label><input type="number" id="factor-sling" class="w-full p-2 border rounded bg-slate-50"></div></div></div></div>
            <div id="tab-content-saved" class="hidden space-y-4"><h4 class="font-bold text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h4><div id="saved-quotations-list" class="space-y-2"></div></div>
        </div>
        <div class="p-4 border-t bg-white flex justify-between items-center gap-3"><span id="admin-mode-status" class="text-xs font-bold">...</span><div><button onclick="logoutAdmin()" id="logoutBtn" class="hidden px-4 py-2 text-red-600 font-bold hover:bg-red-50 rounded-xl mr-auto border border-red-200">‡∏≠‡∏≠‡∏Å</button><button onclick="closeConfig()" class="px-4 py-2 text-slate-600 font-bold hover:bg-slate-100 rounded-xl mr-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="saveConfig()" class="px-6 py-2 bg-sunny-red text-white font-bold rounded-xl shadow-lg hover:bg-red-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div>
    </div>

    <div id="codeListModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-md w-full h-[80vh] flex flex-col relative animate-fade-in-up">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center shrink-0"><h3 class="text-xl font-bold text-slate-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</h3><button onclick="toggleCodeListModal(false)" class="bg-slate-50 p-2 rounded-full hover:bg-slate-100 text-slate-400">X</button></div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="browseListContainer"></div>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-md w-full p-6 relative animate-fade-in-up max-h-[90vh] overflow-y-auto">
             <button onclick="toggleHelpModal(false)" class="absolute top-4 right-4 bg-slate-50 p-2 rounded-full hover:bg-slate-100 text-slate-400">X</button>
             <h3 class="text-xl font-bold text-slate-800 mb-4">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
             <ul class="space-y-2 list-disc pl-4 text-sm text-slate-600">
                 <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</strong></li>
                 <li>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô B35-30</li>
                 <li class="pt-2 font-bold text-slate-700">‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤:</li>
                 <ul class="list-none pl-2 space-y-1 text-xs">
                    <li>ü™ü <strong>‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å:</strong> ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå 1,956 + ‡∏£‡∏≤‡∏á‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á + ‡∏™‡∏•‡∏¥‡∏á</li>
                    <li>üè† <strong>‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô:</strong> ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ú‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1.2 ‡∏ï‡∏£.‡∏°.)</li>
                 </ul>
                 <li class="pt-2 font-bold text-slate-700">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</li>
                 <ul class="list-none pl-2 space-y-1 text-xs">
                     <li>‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</li>
                     <li>‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î (0)</li>
                     <li>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 20)</li>
                 </ul>
             </ul>
             <button onclick="toggleHelpModal(false)" class="mt-6 w-full bg-slate-900 text-white py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <script>
        // --- 1. UTILITY FUNCTIONS (Defined first!) ---
        function isDateNew(dateStr) {
            if(!dateStr) return false;
            const diff = new Date() - new Date(dateStr);
            const days = diff / (1000 * 60 * 60 * 24);
            return days < 7;
        }

        function formatDate(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        function isValidCode(code) {
            if (!code) return false;
            if (code.includes(',') || code.includes('"')) return false;
            const blacklist = ['SLAT', 'PCS', 'BOX', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'NAME', 'CODE', 'PRICE', '35MM', '50MM', 'F-WOOD', '25MM', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á'];
            const upper = code.toUpperCase();
            if (blacklist.some(w => upper.includes(w))) return false;
            if (code.length > 20) return false;
            return true;
        }

        // --- 2. GLOBAL VARIABLES & CONSTANTS ---
        const firebaseConfig = { apiKey: "AIzaSyCAWVxXlTIzt9zvuCZADEVYi1xCtJ8hdcA", authDomain: "sunny1988-a4483.firebaseapp.com", projectId: "sunny1988-a4483", storageBucket: "sunny1988-a4483.firebasestorage.app", messagingSenderId: "436626327232", appId: "1:436626327232:web:b3b67dd892aff358624f25", measurementId: "G-YLW440VTEK" };
        let db = null, auth = null, isOnlineMode = false;
        
        const DEFAULT_CONFIG = { appTitle: "SUNNY", menus: [ { id: 'WOOD', name: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡πÑ‡∏°‡πâ', sub: '', icon: 'wood', active: true }, { id: 'ALU', name: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°', sub: '25mm.', icon: 'alu', active: true }, { id: 'PVC', name: '‡∏â‡∏≤‡∏Å PVC', sub: '(‡πÉ‡∏ö 8.5/10 cm)', icon: 'pvc', active: true }, { id: 'ROLLER', name: '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô', sub: '', icon: 'roller', active: true } ], newsSettings: { speed: 3, showDate: true }, newsItems: [], calcSettings: { enabled: true, factors: { fabricMult: 1.2, minArea: 1.2, eqExt: 1956, railTop: 200, railBot: 150, sling: 69 } } };
        
        let appConfig = JSON.parse(localStorage.getItem('sunny_app_config')) || DEFAULT_CONFIG;
        if(!appConfig.calcSettings) appConfig.calcSettings = DEFAULT_CONFIG.calcSettings;
        if(!appConfig.newsItems) appConfig.newsItems = [];

        const ICONS = { wood: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>', alu: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>', pvc: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>', roller: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>', calc: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>' };
        let currentSystem = 'WOOD', cache = {}, deferredPrompt;
        const EMOJIS = ["üì¢","üî•","üéâ","‚ú®","‚ö†Ô∏è","‚ÄºÔ∏è","üÜï","üÜì","üõë","‚úÖ","‚ùå","üöö","üì¶","üè†","üè¢","üîß","üî®","üìÖ","üïí","‚òÄÔ∏è","üåßÔ∏è","‚≠ê","üåü","üí°","üö©","üìå","üìç","üéÅ","üõí","üí∞","üíµ","üíØ"];
        let currentEmojiTarget = null;
        let calcMode = 'EXT', calcUnit = 'm', calcItems = [];
        let tempConfig = {};

        const STOCK_COLUMNS_WOOD={'4ft':{col:4,meter:'1.22 ‡∏°.'},'4.5ft':{col:6,meter:'1.37 ‡∏°.'},'5ft':{col:8,meter:'1.52 ‡∏°.'},'5.5ft':{col:10,meter:'1.68 ‡∏°.'},'6ft':{col:12,meter:'1.83 ‡∏°.'},'6.5ft':{col:14,meter:'1.98 ‡∏°.'},'7ft':{col:16,meter:'2.13 ‡∏°.'},'8ft':{col:18,meter:'2.44 ‡∏°.'}};
        const WOOD_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1132498145&single=true&output=csv";
        const PVC_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1230787558&single=true&output=csv";
        const ROLLER_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1019928538&single=true&output=csv";
        const ALU_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1880232984&single=true&output=csv";

        // --- 3. CORE FUNCTIONS (DEFINED BEFORE USE) ---
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebarOverlay'); if(sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); document.body.style.overflow='hidden'; } else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); document.body.style.overflow=''; } }
        function toggleHelpModal(s) { document.getElementById('helpModal').classList.toggle('hidden', !s); }
        function toggleCodeListModal(s) { document.getElementById('codeListModal').classList.toggle('hidden', !s); }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-message').innerText=m; t.classList.remove('opacity-0','pointer-events-none','toast-hide'); t.classList.add('toast-show'); setTimeout(()=>{t.classList.remove('toast-show');t.classList.add('toast-hide');},2500); }

        function checkAndNotifyNews(newsItems) {
            if (!newsItems || newsItems.length === 0) return;
            const latest = [...newsItems].sort((a,b) => b.id - a.id)[0];
            if (!latest) return;
            const lastSeenId = parseInt(localStorage.getItem('last_notified_news_id') || '0');
            if (latest.id > lastSeenId) {
                if (Notification.permission === "granted") {
                    try { new Notification("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà: " + latest.badgeLabel, { body: latest.text, icon: "https://cdn-icons-png.flaticon.com/512/1063/1063376.png", tag: "sunny-news" }); } catch (e) { console.log("Notify Error", e); showToast("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà: " + latest.text); }
                }
                localStorage.setItem('last_notified_news_id', latest.id);
            }
        }

        // --- 4. RENDER LOGIC ---
        function renderSidebar() {
            const container = document.getElementById('sidebar-menu-container'); 
            container.innerHTML = `<div class="px-6 mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>`;
            appConfig.menus.forEach(menu => { 
                if (!menu.active) return; 
                const activeClass = currentSystem === menu.id ? 'active' : ''; 
                container.innerHTML += `<a href="#" onclick="switchSystem('${menu.id}')" class="menu-item ${activeClass} flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition-colors"><div class="w-8 flex justify-center mr-2">${ICONS[menu.icon]}</div><div class="flex flex-col"><span class="font-medium">${menu.name}</span>${menu.sub?`<span class="text-[10px] text-slate-400">${menu.sub}</span>`:''}</div></a>`; 
            });
            
            const isAdmin = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (appConfig.calcSettings.enabled || isAdmin) { 
                container.innerHTML += `<div class="px-6 mt-6 mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider flex justify-between"><span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</span>${!appConfig.calcSettings.enabled ? '<span class="text-[9px] bg-red-100 text-red-500 px-1 rounded">Admin View</span>' : ''}</div>
                <a href="#" onclick="switchCalcMode('EXT')" class="flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition-colors"><div class="w-8 flex justify-center mr-2 text-xl">ü™ü</div><span class="font-medium">‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</span></a>
                <a href="#" onclick="switchCalcMode('INT')" class="flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition-colors"><div class="w-8 flex justify-center mr-2 text-xl">üè†</div><span class="font-medium">‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô</span></a>`; 
            }
            
            document.getElementById('app-title-display').innerText = appConfig.appTitle;
            const installBtn = document.getElementById('pwaInstallBtn'); 
            if (deferredPrompt) { 
                installBtn.classList.remove('hidden'); 
                installBtn.onclick = () => { 
                    deferredPrompt.prompt(); 
                    deferredPrompt.userChoice.then((c) => { if (c.outcome === 'accepted') deferredPrompt = null; installBtn.classList.add('hidden'); }); 
                }; 
            }
        }

        function renderNews() {
            const container = document.getElementById('news-container'); 
            const pinnedWrapper = document.getElementById('pinned-news-wrapper'); 
            const scrollWrapper = document.getElementById('scrolling-news-wrapper'); 
            const scrollTrack = document.getElementById('news-ticker-track');
            const news = appConfig.newsItems || [];
            
            if(news.length === 0) { container.classList.add('hidden'); return; } 
            container.classList.remove('hidden');
            
            const pinnedItems = news.filter(n => n.pinned); 
            const scrollItems = news.filter(n => !n.pinned);
            
            pinnedWrapper.innerHTML = '';
            pinnedItems.forEach(item => {
                const isNew = isDateNew(item.date);
                pinnedWrapper.innerHTML += `<div class="bg-gradient-to-r from-red-50 to-white border border-red-100 p-3 rounded-xl shadow-sm flex items-start gap-3 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-sunny-red"></div>
                    <div class="text-sunny-red mt-0.5"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg></div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                            ${isNew ? `<span class="px-1.5 py-0.5 rounded text-[10px] font-bold shadow-sm" style="background-color: ${item.badgeColor}; color: ${item.badgeTextColor}">${item.badgeLabel}</span>` : ''}
                            <span class="text-[10px] text-slate-400 font-medium bg-white px-1.5 rounded border border-slate-100">${formatDate(item.date)}</span>
                        </div>
                        <p class="text-sm font-semibold whitespace-normal break-words leading-relaxed" style="color: ${item.textColor}">${item.text}</p>
                    </div>
                </div>`;
            });

            if (scrollItems.length > 0) {
                scrollWrapper.classList.remove('hidden');
                let html = '';
                const createItem = (item) => `<div class="h-28 flex items-center gap-3 px-2 w-full shrink-0"><div class="flex-1 min-w-0 flex flex-col justify-center h-full"><div class="flex items-center gap-2 mb-0.5">${isDateNew(item.date) ? `<span class="px-1.5 py-0.5 rounded-[4px] text-[9px] font-bold" style="background-color: ${item.badgeColor}; color: ${item.badgeTextColor}">${item.badgeLabel}</span>` : ''}<span class="text-[10px] text-slate-400">${formatDate(item.date)}</span></div><div class="text-sm font-medium whitespace-normal break-words leading-snug line-clamp-4" style="color: ${item.textColor}">${item.text}</div></div></div>`;
                scrollItems.forEach(item => html += createItem(item));
                if (scrollItems.length > 0) scrollItems.forEach(item => html += createItem(item));
                scrollTrack.innerHTML = html;
                const duration = (7 - appConfig.newsSettings.speed) * scrollItems.length;
                scrollTrack.style.animation = `verticalSlide ${duration}s linear infinite`;
            } else {
                scrollWrapper.classList.add('hidden');
            }
        }

        // --- 5. DATA FETCHING ---
        function parseWoodCSV(t){const l=t.trim().split('\n'),d={};let lc=null;for(let i=2;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(!c&&lc){const h=Object.values(STOCK_COLUMNS_WOOD).some(o=>cr[o.col]&&cr[o.col]!=='0');if(cr[1]||h)c=lc}if(c){c=c.toUpperCase();if(!isValidCode(c))continue;lc=c;if(!d[c]){d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{}};Object.keys(STOCK_COLUMNS_WOOD).forEach(k=>d[c].stocks[k]=0)}for(const[k,o]of Object.entries(STOCK_COLUMNS_WOOD))if(cr.length>o.col)d[c].stocks[k]+=parseInt(cr[o.col].replace(/,/g,'')||0,10)}}return d}
        function parseAluCSV(t){const l=t.trim().split('\n'),d={};for(let i=1;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(c){c=c.toUpperCase();if(!isValidCode(c))continue;const v=parseInt(cr[2].replace(/,/g,'')||0,10);if(!d[c])d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠':v}};else d[c].stocks['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']+=v}}return d}
        function parsePvcCSV(t){const l=t.trim().split('\n'),d={};const hr=l[1].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c=>c.trim().replace(/^"|"$/g,''));const hm=[];for(let i=2;i<hr.length;i++)if(hr[i]&&!isNaN(parseInt(hr[i])))hm.push({index:i,label:hr[i]});for(let i=2;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(c){c=c.toUpperCase();if(!isValidCode(c))continue;if(!d[c])d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{}};hm.forEach(h=>{if(cr.length>h.index)d[c].stocks[h.label]=(d[c].stocks[h.label]||0)+parseInt(cr[h.index].replace(/,/g,'')||0,10)})}}return d}
        function parseRollerCSV(t){const l=t.trim().split('\n'),d={};for(let i=3;i<l.length;i++){const r=l[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/),cr=r.map(c=>c?c.trim().replace(/^"|"$/g,''):'');let c=cr[0];if(c){c=c.toUpperCase();if(!isValidCode(c))continue;const v=parseInt(cr[2].replace(/,/g,'')||0,10);if(!d[c])d[c]={name:cr[1]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',stocks:{'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠':v}};else d[c].stocks['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']+=v}}return d}

        async function fetchData(sysId) {
            const system = sysId || currentSystem; 
            if (cache[system]) return cache[system];
            let url = (system==='WOOD')?WOOD_CSV_URL:(system==='ALU')?ALU_CSV_URL:(system==='PVC')?PVC_CSV_URL:ROLLER_CSV_URL;
            try {
                const response = await fetch(url, { cache: "no-store" }); if (!response.ok) throw new Error('Network Error');
                const text = await response.text(); let parsedData;
                if (system==='WOOD') parsedData = parseWoodCSV(text); else if (system==='ALU') parsedData = parseAluCSV(text); else if (system==='PVC') parsedData = parsePvcCSV(text); else parsedData = parseRollerCSV(text);
                cache[system] = parsedData; 
                if (currentSystem === system) document.getElementById('lastUpdateDisplay').innerText = new Date().toLocaleDateString('th-TH', { hour: '2-digit', minute: '2-digit' }) + ' ‡∏ô.';
                return parsedData;
            } catch (e) { console.error(e); throw e; }
        }

        async function updateProductList() {
            const activeSystem = currentSystem; 
            const browse = document.getElementById('browseListContainer');
            browse.innerHTML = `<div class="flex justify-center items-center h-full text-slate-400"><span class="loader w-6 h-6 border-2 border-slate-300 border-t-sunny-red rounded-full mr-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
            try {
                const data = await fetchData(activeSystem);
                if (currentSystem !== activeSystem) return;
                const datalist = document.getElementById('codeSuggestions'); datalist.innerHTML = ''; browse.innerHTML = '';
                const codes = Object.keys(data).sort();
                if(codes.length===0) { browse.innerHTML = `<div class="text-center text-slate-400 mt-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`; return; }
                codes.forEach(code => {
                    const opt = document.createElement('option'); opt.value = code; datalist.appendChild(opt);
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left bg-slate-50 hover:bg-red-50 p-4 rounded-xl border border-slate-100 hover:border-red-100 transition-all flex justify-between items-center group";
                    btn.onclick = () => { document.getElementById('productCodeInput').value = code; toggleCodeListModal(false); searchProduct(); };
                    btn.innerHTML = `<div><span class="block font-bold text-lg text-slate-700 group-hover:text-sunny-red">${code}</span></div><svg class="h-5 w-5 text-slate-300 group-hover:text-sunny-red" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`;
                    browse.appendChild(btn);
                });
            } catch (error) { browse.innerHTML = `<div class="text-center text-red-400 mt-10">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }

        async function searchProduct() {
            const input = document.getElementById('productCodeInput'); const code = input.value.trim().toUpperCase(); if (!code) return;
            const ids = ['loadingIndicator', 'productCard', 'errorMessage', 'initialMessage']; ids.forEach(id => document.getElementById(id).classList.add('hidden')); 
            document.getElementById('loadingIndicator').classList.remove('hidden'); const btn = document.getElementById('searchButton'); btn.disabled = true; btn.innerHTML = '<span class="loader block w-5 h-5 border-2 border-white/50 border-t-white rounded-full"></span>';
            try {
                const data = await fetchData(currentSystem); const result = data[code];
                document.getElementById('loadingIndicator').classList.add('hidden'); btn.disabled = false; btn.innerText = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                if (result) {
                    document.getElementById('productCodeDisplay').innerText = code; document.getElementById('productName').innerText = result.name;
                    const grid = document.getElementById('stockGrid'); grid.innerHTML = '';
                    const isSingle = currentSystem === 'ROLLER' || currentSystem === 'ALU';
                    grid.className = isSingle ? 'grid grid-cols-1 gap-4 pb-4 max-w-sm mx-auto' : 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 pb-4';
                    const createCard = (l, sl, q) => {
                        const isZ = q === 0, isL = q > 0 && q < 20;
                        return `<div class="bento-card relative rounded-2xl p-4 border flex flex-col justify-between ${isSingle?'h-40 items-center justify-center text-center':'h-28'} ${isZ?'bg-slate-50 opacity-60 text-slate-400':(isL?'bg-white border-red-200 ring-1 ring-red-100 text-red-600':'bg-white text-slate-800')} shadow-sm group"><div class="${isSingle?'w-full flex justify-between mb-2':'flex justify-between items-start'}"><div><span class="font-bold text-base md:text-lg">${l}</span>${sl?`<span class="block text-[10px] bg-slate-100 px-1.5 rounded-md w-fit mt-0.5 ${isSingle?'mx-auto':''}">${sl}</span>`:''}</div><div class="rounded-full p-1 ${isZ?'bg-red-100 text-red-400':(isL?'bg-red-500 text-white':'bg-green-500 text-white')}"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="${isZ?'M6 18L18 6M6 6l12 12':'M5 13l4 4L19 7'}"></path></svg></div></div><div class="${isSingle?'text-center mt-2':'text-right'}"><span class="block ${isSingle?'text-5xl':'text-3xl'} font-black tracking-tight leading-none">${q.toLocaleString()}</span>${isSingle?'<span class="text-sm text-slate-400 mt-1 block">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>':''}</div></div>`;
                    };
                    if(currentSystem==='WOOD') Object.keys(STOCK_COLUMNS_WOOD).forEach(k => grid.innerHTML+=createCard(k, STOCK_COLUMNS_WOOD[k].meter, result.stocks[k]));
                    else if(currentSystem==='PVC') Object.keys(result.stocks).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(k => grid.innerHTML+=createCard(`‡∏™‡∏π‡∏á ${k}`, '‡∏ã‡∏°.', result.stocks[k]));
                    else grid.innerHTML += createCard('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '', result.stocks['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']);
                    document.getElementById('productCard').classList.remove('hidden');
                } else {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    document.getElementById('errorText').innerText = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ${appConfig.menus.find(m=>m.id===currentSystem).name}`;
                }
            } catch (error) { console.error(error); document.getElementById('loadingIndicator').classList.add('hidden'); btn.disabled = false; btn.innerText = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'; document.getElementById('errorMessage').classList.remove('hidden'); document.getElementById('errorText').innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'; }
        }

        // --- 6. SWITCH & INIT ---
        function switchSystem(system) {
            currentSystem = system;
            document.getElementById('searchSection').classList.remove('hidden'); document.getElementById('calculatorSection').classList.add('hidden');
            const menu = appConfig.menus.find(m => m.id === system);
            if(!menu) return;
            document.getElementById('systemTitle').innerText = "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å " + menu.name; document.getElementById('productTypeLabel').innerText = menu.name; document.getElementById('productCodeInput').value = ''; document.getElementById('productCodeInput').placeholder = system==='WOOD'?'‡πÄ‡∏ä‡πà‡∏ô B35-34...':system==='PVC'?'‡πÄ‡∏ä‡πà‡∏ô 926...':system==='ALU'?'‡πÄ‡∏ä‡πà‡∏ô 001...':'‡πÄ‡∏ä‡πà‡∏ô SZH...'; document.getElementById('productCard').classList.add('hidden'); document.getElementById('initialMessage').classList.remove('hidden');
            if (window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebarOverlay').classList.add('hidden'); document.body.style.overflow=''; }
            updateProductList();
        }

        function switchCalcMode(mode) {
            calcMode = mode;
            document.getElementById('searchSection').classList.add('hidden'); document.getElementById('calculatorSection').classList.remove('hidden');
            const title = mode === 'EXT' ? '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' : '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô'; const icon = mode === 'EXT' ? 'ü™ü' : 'üè†';
            document.getElementById('calcTitleText').innerText = title; document.getElementById('calcTitleIcon').innerText = icon;
            toggleSidebar();
        }

        function initFirebase() {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") return;
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                auth.signInAnonymously().then(() => {
                    isOnlineMode = true;
                    db.collection("app_settings").doc("config").onSnapshot((doc) => {
                        if (doc.exists) {
                            const newData = doc.data();
                            checkAndNotifyNews(newData.newsItems || []);
                            appConfig = newData;
                            if(!appConfig.calcSettings) appConfig.calcSettings = DEFAULT_CONFIG.calcSettings;
                            if(!appConfig.newsItems) appConfig.newsItems = [];
                            appConfig.newsItems.forEach(item => { if(!item.badgeTextColor) item.badgeTextColor = "#FFFFFF"; });
                            localStorage.setItem('sunny_app_config', JSON.stringify(appConfig));
                            renderSidebar(); renderNews(); 
                        } else { db.collection("app_settings").doc("config").set(appConfig); }
                    });
                }).catch(console.error);
            } catch (error) { console.error("Firebase Init Error:", error); }
        }

        window.addEventListener('DOMContentLoaded', () => { initFirebase(); renderSidebar(); switchSystem('WOOD'); renderNews(); setTimeout(() => { const s = document.getElementById('intro-splash'); if(s) { s.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => s.remove(), 700); } }, 2000); });

        // --- 7. ADMIN, CALC & OTHER HELPERS ---
        function addCalcItem() {
            const wInput = parseFloat(document.getElementById('calcW').value), hInput = parseFloat(document.getElementById('calcH').value), price = parseFloat(document.getElementById('calcPrice').value), qty = parseInt(document.getElementById('calcQty').value) || 1;
            if(!wInput || !hInput || !price) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
            const w = calcUnit === 'cm' ? wInput/100 : wInput, h = calcUnit === 'cm' ? hInput/100 : hInput, f = appConfig.calcSettings.factors;
            let rawArea = w * h * f.fabricMult, finalArea = rawArea < f.minArea ? f.minArea : rawArea, fabricCost = finalArea * price, totalPerSet = 0, details = ``;
            if(calcMode === 'EXT') {
                const topRail = w * f.railTop, botRail = w * f.railBot, sling = h * f.sling * 2; totalPerSet = fabricCost + f.eqExt + topRail + botRail + sling;
                details = `‡∏ú‡πâ‡∏≤: ${w.toFixed(2)}x${h.toFixed(2)}x${f.fabricMult}=${rawArea.toFixed(2)}${rawArea<f.minArea?`(‡∏õ‡∏£‡∏±‡∏ö${f.minArea})`:''}x${price}=${fabricCost.toLocaleString()} | ‡∏≠‡∏õ‡∏Å: ${f.eqExt.toLocaleString()} | ‡∏£‡∏≤‡∏á‡∏ö‡∏ô: ${topRail.toLocaleString()} | ‡∏£‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á: ${botRail.toLocaleString()} | ‡∏™‡∏•‡∏¥‡∏á: ${sling.toLocaleString()}`;
            } else { totalPerSet = fabricCost; details = `‡∏ú‡πâ‡∏≤: ${w.toFixed(2)}x${h.toFixed(2)}x${f.fabricMult}=${rawArea.toFixed(2)}${rawArea<f.minArea?`(‡∏õ‡∏£‡∏±‡∏ö${f.minArea})`:''}x${price}=${fabricCost.toLocaleString()}`; }
            calcItems.push({ w: wInput, h: hInput, unit: calcUnit, price: price, qty: qty, totalPerSet: totalPerSet, grandTotal: totalPerSet * qty, details: details });
            renderCalcTable(); document.getElementById('calcW').value = ''; document.getElementById('calcH').value = '';
        }
        function renderCalcTable() { const tbody = document.getElementById('calcTableBody'); tbody.innerHTML = ''; let sum = 0; calcItems.forEach((item, idx) => { sum += item.grandTotal; tbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0"><td class="px-3 py-3 font-bold">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${idx+1}</td><td class="px-3 py-3 text-slate-500">${item.w}x${item.h} ${item.unit}</td><td class="px-3 py-3 text-right">${item.totalPerSet.toLocaleString()}</td><td class="px-3 py-3 text-right font-bold">${item.grandTotal.toLocaleString()}</td><td class="px-3 py-3 text-right"><button onclick="removeCalcItem(${idx})" class="text-red-300 hover:text-red-500">x</button></td></tr>`; }); document.getElementById('totalItems').innerText = calcItems.length; document.getElementById('grandTotal').innerText = sum.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function removeCalcItem(idx) { calcItems.splice(idx, 1); renderCalcTable(); }
        function clearCalc() { calcItems = []; renderCalcTable(); }

        function showQuotationModal() { if(calcItems.length === 0) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; } document.getElementById('quotationModal').classList.remove('hidden'); document.getElementById('qDate').innerText = new Date().toLocaleDateString('th-TH'); document.getElementById('qType').innerText = calcMode === 'EXT' ? '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' : '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô'; const tbody = document.getElementById('qBody'), detailContent = document.getElementById('qDetailContent'); tbody.innerHTML = ''; detailContent.innerHTML = ''; let sum = 0; calcItems.forEach((item, idx) => { sum += item.grandTotal; tbody.innerHTML += `<tr><td class="py-2"><span class="font-bold">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${idx+1}</span> <span class="text-xs text-slate-500 ml-2">(${item.w}x${item.h} ${item.unit})</span></td><td class="py-2 text-center">${item.qty}</td><td class="py-2 text-right">${item.totalPerSet.toLocaleString()}</td><td class="py-2 text-right font-bold">${item.grandTotal.toLocaleString()}</td></tr>`; detailContent.innerHTML += `<div class="border-b border-slate-200 pb-2 last:border-0"><span class="font-bold text-sunny-red">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${idx+1}:</span><br>${item.details}</div>`; }); document.getElementById('qGrandTotal').innerText = sum.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó'; }
        function closeQuotation() { document.getElementById('quotationModal').classList.add('hidden'); }
        function toggleQDetails() { document.getElementById('qDetails').classList.toggle('hidden'); }
        function captureQuotation() { html2canvas(document.querySelector("#quotationContent"), { scale: 2, useCORS: true }).then(canvas => { const link = document.createElement('a'); link.download = `Sunny_Quote_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); }); }
        function saveCurrentQuotation() { if (!confirm('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö?')) return; const qData = { id: Date.now(), date: new Date().toISOString(), type: calcMode === 'EXT' ? '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' : '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô', total: document.getElementById('qGrandTotal').innerText, items: calcItems }; if (isOnlineMode) { db.collection("quotations").add(qData).then(() => showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")).catch(e => alert("Error: " + e.message)); } else { let saved = JSON.parse(localStorage.getItem('sunny_quotations')) || []; saved.push(qData); localStorage.setItem('sunny_quotations', JSON.stringify(saved)); showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å(Offline)‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); } }
        async function loadSavedQuotations() { const list = document.getElementById('saved-quotations-list'); list.innerHTML = '<div class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>'; let quotes = []; if (isOnlineMode) { try { const snap = await db.collection("quotations").orderBy("id", "desc").limit(20).get(); snap.forEach(doc => quotes.push({ ...doc.data(), docId: doc.id })); } catch (e) { list.innerHTML = "Error"; return; } } else { quotes = JSON.parse(localStorage.getItem('sunny_quotations')) || []; quotes.sort((a,b) => b.id - a.id); } if(quotes.length === 0) { list.innerHTML = '<div class="text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; } list.innerHTML = ''; quotes.forEach(q => { const dateStr = new Date(q.date || q.id).toLocaleString('th-TH'); const div = document.createElement('div'); div.className = "bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center text-sm"; div.innerHTML = `<div><div class="font-bold text-slate-700">${q.type}</div><div class="text-xs text-slate-400">${dateStr}</div></div><div class="text-right"><div class="font-bold text-sunny-red">${q.total}</div><button onclick='viewSavedQuote(${JSON.stringify(q)})' class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 mt-1">‡∏î‡∏π</button>${isOnlineMode ? `<button onclick="deleteOnlineQuote('${q.docId}')" class="text-xs text-white bg-red-400 hover:bg-red-500 px-2 py-1 rounded ml-1">‡∏•‡∏ö</button>` : `<button onclick="deleteOfflineQuote(${q.id})" class="text-xs text-white bg-red-400 hover:bg-red-500 px-2 py-1 rounded ml-1">‡∏•‡∏ö</button>`}</div>`; list.appendChild(div); }); }
        function viewSavedQuote(q) { calcMode = q.type === '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'EXT' : 'INT'; calcItems = q.items; showQuotationModal(); closeConfig(); }
        async function deleteOnlineQuote(docId) { if(!confirm('‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?')) return; try { await db.collection("quotations").doc(docId).delete(); showToast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); loadSavedQuotations(); } catch(e) { alert("Error: " + e.message); } }
        function deleteOfflineQuote(id) { if(!confirm('‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?')) return; let saved = JSON.parse(localStorage.getItem('sunny_quotations')) || []; saved = saved.filter(x => x.id !== id); localStorage.setItem('sunny_quotations', JSON.stringify(saved)); loadSavedQuotations(); }

        // --- ADMIN LOGIN & EMOJI ---
        function checkAdminLogin() { if (localStorage.getItem('isAdminLoggedIn') === 'true') openConfig(); else openAdminLogin(); }
        function openAdminLogin() { document.getElementById('adminLoginModal').classList.remove('hidden'); document.getElementById('adminPassword').value=''; document.getElementById('loginError').classList.add('hidden'); document.getElementById('adminPassword').focus(); }
        function closeAdminLogin() { document.getElementById('adminLoginModal').classList.add('hidden'); }
        function handleLogin() { if(document.getElementById('adminPassword').value === 'sn1988') { localStorage.setItem('isAdminLoggedIn', 'true'); closeAdminLogin(); showToast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); openConfig(); renderSidebar(); } else { document.getElementById('loginError').classList.remove('hidden'); } }
        function logoutAdmin() { localStorage.removeItem('isAdminLoggedIn'); closeConfig(); showToast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); renderSidebar(); }
        
        function requestNotificationPermission() { if (!("Notification" in window)) { alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"); return; } Notification.requestPermission().then(permission => { if (permission === "granted") { showToast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); try { new Notification("SUNNY Stock", { body: "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö", icon: "https://cdn-icons-png.flaticon.com/512/1063/1063376.png" }); } catch(e) {} } else if (permission === "denied") { alert("‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"); } else { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Allow) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"); } renderSidebar(); }); }
        
        function initEmojiPicker() { const p = document.getElementById('emojiPicker'); if(!p) return; p.innerHTML=''; EMOJIS.forEach(e=>{ const b=document.createElement('button'); b.innerText=e; b.className="text-xl hover:bg-slate-100 p-2 rounded text-center"; b.onclick=()=>insertEmoji(e); p.appendChild(b); }); }
        function openEmojiPicker(btn, field, idx) { const p = document.getElementById('emojiPicker'); const r = btn.getBoundingClientRect(); let t = r.bottom + window.scrollY + 5; let l = r.left + window.scrollX - 200; if(l<10) l=10; if(window.innerWidth-l<300) l=window.innerWidth-320; p.style.top=t+'px'; p.style.left=l+'px'; p.classList.remove('hidden'); currentEmojiTarget = { field, idx }; if(p.children.length===0) initEmojiPicker(); }
        function insertEmoji(e) { if(!currentEmojiTarget) return; const { field, idx } = currentEmojiTarget; const id = field === 'text' ? `news-text-${idx}` : `news-badge-${idx}`; const el = document.getElementById(id); if(el) { const s = el.selectionStart, end = el.selectionEnd, txt = el.value; const n = txt.substring(0, s) + e + txt.substring(end); el.value = n; if(field==='text') tempConfig.newsItems[idx].text=n; if(field==='badge') tempConfig.newsItems[idx].badgeLabel=n; el.focus(); try{el.selectionStart=el.selectionEnd=s+e.length;}catch(err){} } document.getElementById('emojiPicker').classList.add('hidden'); }
        window.addEventListener('click', (e) => { const p = document.getElementById('emojiPicker'); if (!p.classList.contains('hidden') && !e.target.closest('button[onclick^="openEmojiPicker"]') && !e.target.closest('#emojiPicker')) p.classList.add('hidden'); });

        function openConfig() { tempConfig = JSON.parse(JSON.stringify(appConfig)); document.getElementById('adminConfigModal').classList.remove('hidden'); document.getElementById('conf-app-title').value = tempConfig.appTitle; document.getElementById('conf-news-speed').value = tempConfig.newsSettings.speed || 3; document.getElementById('conf-calc-enabled').checked = tempConfig.calcSettings.enabled; document.getElementById('factor-fabricMult').value = tempConfig.calcSettings.factors.fabricMult; document.getElementById('factor-minArea').value = tempConfig.calcSettings.factors.minArea; document.getElementById('factor-eqExt').value = tempConfig.calcSettings.factors.eqExt; document.getElementById('factor-railTop').value = tempConfig.calcSettings.factors.railTop; document.getElementById('factor-railBot').value = tempConfig.calcSettings.factors.railBot; document.getElementById('factor-sling').value = tempConfig.calcSettings.factors.sling; const st = document.getElementById('admin-mode-status'); st.innerText = isOnlineMode ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Online Mode" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Offline Mode"; switchAdminTab('menu'); }
        function closeConfig() { document.getElementById('adminConfigModal').classList.add('hidden'); }
        function switchAdminTab(tab) { ['menu','news','calc','saved'].forEach(t => { document.getElementById('tab-btn-'+t).className = "px-4 py-3 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:bg-slate-50 whitespace-nowrap"; document.getElementById('tab-content-'+t).classList.add('hidden'); }); document.getElementById('tab-btn-'+tab).className = "px-4 py-3 text-sm font-bold border-b-2 border-sunny-red text-sunny-red bg-red-50 whitespace-nowrap"; document.getElementById('tab-content-'+tab).classList.remove('hidden'); if(tab==='menu') renderAdminMenu(); if(tab==='news') renderAdminNews(); if(tab==='saved') loadSavedQuotations(); }
        function renderAdminMenu() { const l = document.getElementById('admin-menu-list'); l.innerHTML = ''; tempConfig.menus.forEach((m, i) => { l.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-200 flex items-center gap-3"><div class="p-2 bg-slate-100 rounded text-slate-500">${ICONS[m.icon]}</div><div class="flex-grow space-y-1"><input type="text" value="${m.name}" onchange="tempConfig.menus[${i}].name=this.value" class="w-full p-1 border rounded text-sm font-bold"><input type="text" value="${m.sub}" onchange="tempConfig.menus[${i}].sub=this.value" class="w-full p-1 border rounded text-xs text-slate-500"></div><input type="checkbox" ${m.active?'checked':''} onchange="tempConfig.menus[${i}].active=this.checked" class="w-5 h-5 accent-sunny-red"></div>`; }); }
        function renderAdminNews() { const l = document.getElementById('admin-news-list'); l.innerHTML = ''; const s = [...tempConfig.newsItems].sort((a,b) => (b.pinned===a.pinned)? 0 : b.pinned? 1 : -1); s.forEach((item, idx) => { const rIdx = tempConfig.newsItems.findIndex(x => x.id === item.id); l.innerHTML += `<div class="p-4 rounded-xl border ${item.pinned ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200'} relative group shadow-sm"><div class="flex flex-col gap-3"><div class="flex items-start justify-between gap-3"><div class="flex-1 space-y-2"><div class="flex justify-between items-center"><label class="text-[10px] text-slate-400 font-bold uppercase">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label><button onclick="openEmojiPicker(this, 'text', ${rIdx})" class="text-slate-400 hover:text-yellow-500 transition-colors text-sm">üòÄ</button></div><textarea id="news-text-${rIdx}" rows="2" class="w-full p-2 text-sm border rounded bg-white" onchange="tempConfig.newsItems[${rIdx}].text=this.value">${item.text}</textarea></div><div class="flex flex-col gap-2 pt-6"><button onclick="togglePinNews(${rIdx})" class="${item.pinned?'text-white bg-sunny-red':'text-slate-400 bg-white border'} p-2 rounded-lg">üìå</button><button onclick="deleteNews(${rIdx})" class="text-slate-400 hover:text-red-500 bg-white border p-2 rounded-lg">üóëÔ∏è</button></div></div><div class="grid grid-cols-2 md:grid-cols-3 gap-3 border-t pt-3"><div><div class="flex justify-between items-center mb-1"><label class="block text-[10px] text-slate-500 font-bold">‡∏Ñ‡∏≥‡∏õ‡πâ‡∏≤‡∏¢</label><button onclick="openEmojiPicker(this, 'badge', ${rIdx})" class="text-slate-400 hover:text-yellow-500 transition-colors text-xs">üòÄ</button></div><input id="news-badge-${rIdx}" type="text" value="${item.badgeLabel}" onchange="tempConfig.newsItems[${rIdx}].badgeLabel=this.value" class="w-full p-1 text-xs border rounded"></div><div class="flex gap-2"><div class="flex-1"><label class="block text-[10px] text-slate-500 font-bold">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô</label><input type="color" value="${item.badgeColor}" onchange="tempConfig.newsItems[${rIdx}].badgeColor=this.value" class="h-8 w-full border rounded cursor-pointer"></div><div class="flex-1"><label class="block text-[10px] text-slate-500 font-bold">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</label><input type="color" value="${item.badgeTextColor}" onchange="tempConfig.newsItems[${rIdx}].badgeTextColor=this.value" class="h-8 w-full border rounded cursor-pointer"></div></div><div class="flex gap-2"><div class="flex-1"><label class="block text-[10px] text-slate-500 font-bold">‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label><input type="color" value="${item.textColor}" onchange="tempConfig.newsItems[${rIdx}].textColor=this.value" class="h-8 w-full border rounded cursor-pointer"></div><div class="flex-[1.5]"><label class="block text-[10px] text-slate-500 font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" value="${item.date}" onchange="tempConfig.newsItems[${rIdx}].date=this.value" class="w-full p-1 text-xs border rounded"></div></div></div></div></div>`; }); }
        function addNewNewsItem() { tempConfig.newsItems.unshift({ id: Date.now(), text: "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà...", date: new Date().toISOString().split('T')[0], badgeLabel: "NEW!", badgeColor: "#E63946", badgeTextColor: "#FFFFFF", textColor: "#334155", pinned: false }); renderAdminNews(); }
        function togglePinNews(idx) { tempConfig.newsItems[idx].pinned = !tempConfig.newsItems[idx].pinned; renderAdminNews(); }
        function deleteNews(idx) { if(confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®?')) { tempConfig.newsItems.splice(idx, 1); renderAdminNews(); } }
        function saveConfig() { tempConfig.appTitle = document.getElementById('conf-app-title').value; tempConfig.newsSettings.speed = parseInt(document.getElementById('conf-news-speed').value); tempConfig.calcSettings.enabled = document.getElementById('conf-calc-enabled').checked; tempConfig.calcSettings.factors.fabricMult = parseFloat(document.getElementById('factor-fabricMult').value); tempConfig.calcSettings.factors.minArea = parseFloat(document.getElementById('factor-minArea').value); tempConfig.calcSettings.factors.eqExt = parseFloat(document.getElementById('factor-eqExt').value); tempConfig.calcSettings.factors.railTop = parseFloat(document.getElementById('factor-railTop').value); tempConfig.calcSettings.factors.railBot = parseFloat(document.getElementById('factor-railBot').value); tempConfig.calcSettings.factors.sling = parseFloat(document.getElementById('factor-sling').value); appConfig = tempConfig; if (isOnlineMode) db.collection("app_settings").doc("config").set(appConfig).then(() => { showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); closeConfig(); renderSidebar(); }); else { localStorage.setItem('sunny_app_config', JSON.stringify(appConfig)); renderSidebar(); renderNews(); switchSystem(currentSystem); checkAndNotifyNews(appConfig.newsItems); showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å(Offline)‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); closeConfig(); } }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; renderSidebar(); });
        async function promptInstall() { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') deferredPrompt = null; renderSidebar(); } }
    </script>
</body>
</html>
